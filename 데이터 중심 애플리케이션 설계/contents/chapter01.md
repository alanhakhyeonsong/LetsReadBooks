# 1장. 신뢰할 수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션
오늘날 많은 애플리케이션은 계산 중심과는 다르게 **데이터 중심 적이다.** CPU 성능은 애플리케이션을 제한하는 요소가 아니며, 더 큰 문제는 보통 데이터의 양, 데이터의 복잡도, 데이터의 변화 속도다.

일반적으로 데이터 중심 애플리케이션은 곹옹으로 필요로 하는 기능을 제공하는 표준 구성 요소로 만든다.
- 데이터베이스: 구동 에플리케이션이나 다른 애플리케이션에서 나중에 다시 데이터를 찾을 수 있게 데이터를 저장
- 캐시: 읽기 속도 향상을 위해 값비싼 수행 결과를 기억
- 검색 색인: 사용자가 키워드로 데이터를 검색하거나 다양한 방법으로 필터링할 수 있게 제공
- 스트림 처리: 비동기 처리를 위해 다른 프로세스로 메시지 보내기
- 일괄 처리: 주기적으로 대량의 누적된 데이터를 분석

애플리케이션마다 요구사항이 다르기 때문에 데이터베이스 시스템 또한 저마다 다양한 특성을 가지고 있다.

## 데이터 시스템에 대한 생각
일반적으로 데이터베이스, 큐, 캐시 등을 매우 다른 범주에 속하는 도구로 생각하지만, 데이터 시스템이라는 포괄적 용어로 묶곤 한다.

- 데이터 저장과 처리를 위한 여러 새로운 도구는 최근에 만들어졌다. 분류 간 경계가 흐려지고 있다.
- 점점 더 많은 애플리케이션이 단일 도구로는 더 이상 데이터 처리와 저장 모두를 만족시킬 수 없는 과도하고 광범위한 요구사항을 갖고 있다. 대신 작업은 단일 도구에서 효율적으로 수행할 수 있는 태스크로 나누고 다양한 도구들은 애플리케이션 코드를 이용해 서로 연결한다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/5196f3af-6cef-47fd-be2f-5a0acb30d1b3)

메인 데이터베이스와 분리된 애플리케이션 관리 계층이나 엘라스틱 서치 같은 전문 검색 서버의 경우 메인 데이터베이스와 동기화된 캐시나 색인을 유지하는 것은 보통 애플리케이션 코드의 책임이다.

서비스 제공을 위해 각 도구를 결합할 때 서비스 인터페이스나 API는 보통 클라이언트가 모르게 구현 세부 사항을 숨긴다. 기본적으로 좀 더 작은 범용 구성 요소들로 새롭고 특수한 목적의 데이터 시스템을 만든다.

데이터 시스템이나 서비스를 설계할 때 까다로운 문제가 많이 생긴다.
- 내부적 문제가 있어도 데이터를 정확하고 안전하게 유지하려면?
- 시스템의 일부 성능이 저하되더라도 클라이언트에게 일관되게 좋은 성능을 어떻게 제공할 수 있을까?
- 부하 증가를 다루기 위해 어떻게 규모를 확장할까?
- 서비스를 위해 좋은 API는 모습은 어떤 모습일까?

이 책에선 대부분의 소프트웨어 시스템에서 중요하게 여겨지는 세 가지 관심사에 중점을 둔다.
- 신뢰성: 하드웨어나 소프트웨어 결함, 심지어 인적 오류 같은 역경에 직면하더라도 시스템은 지속적으로 올바르게 동작
- 확장성: 시스템의 데이터 양, 트래픽 양, 복잡도가 증가하면서 이를 처리할 수 있는 적절한 방법이 있어야 한다.
- 유지보수성: 시간이 지남에 따라 여러 다양한 사람들이 시스템 상에서 작업할 것이기 때문에 모든 사용자가 시스템 상에서 생산적으로 작업할 수 있게 해야 한다.

## 신뢰성
누구나 어떤 것을 신뢰하거나 신뢰하지 않는다는 의미가 무엇인지에 대한 직관적인 개념을 가지고 있다. 소프트웨어의 경우 일반적인 기대치는 다음과 같다.

- 애플리케이션은 사용자가 기대한 기능을 수행한다.
- 시스템은 사용자가 범한 실수나 예상치 못한 소프트웨어 사용법을 허용할 수 있다.
- 시스템 성능은 예상된 부하와 데이터 양에서 필수적인 사용 사례를 충분히 만족한다.
- 시스템은 허가되지 않은 접근과 오남용을 방지한다.

이 모든 것이 "올바르게 동작함"을 의미하는 경우, 대략 "무언가 잘못되더라도 지속적으로 올바르게 동작함"을 신뢰성의 의미로 이해할 수 있다.

잘못될 수 있는 일을 결함이라 부른다. 그리고 결함을 예측하고 대처할 수 있는 시스템을 내결함성 또는 탄력성을 지녔다고 말한다. 모든 종류의 결함을 견딜 수 있는 시스템은 실현 불가능하다. 따라서 특정 유형의 결함 내성에 대해서만 이야기하는 것이 타당하다.

**결함은 장애와 동일하지 않다.** 일반적으로 결함은 사양에서 벗어난 시스템의 한 구성 요소로 정의되지만, 장애는 사용자에게 필요한 서비스를 제공하지 못하고 시스템 전체가 멈춘 경우다. 결함 확률을 0으로 줄이는 것은 불가능하다. 따라서 대개 결함으로 인해 장애가 발생하지 않게끔 내결함성 구조를 설계하는 것이 가장 좋다.

### 하드웨어 결함
하드디스크 고장, 램 결함, 대규모 정전 사태 발생, 네트워크 케이블을 잘못 뽑는 것과 같은 결함을 말한다. 규모가 큰 데이터센터에선 늘상 일어난다고 한다.

- 각 하드웨어 구성 요소에 중복을 추가한다.
- 디스크는 RAID 구성으로 설치
- 서버는 이중 전원 디바이스와 핫 스왑 가능한 CPU 구성
- 데이터센터는 건전지와 예비 전원용 디젤 발전기를 갖춘다.

최근까지 단일 장비의 전체 장애는 매우 드물기 때문에 대부분의 애플리케이션은 하드웨어 구성 요소의 중복으로 충분했다. 하지만 데이터 양과 애플리케이션의 계산 요구가 늘어나면서 더 많은 애플리케이션이 많은 수의 장비를 사용하게 됐고 이와 비례해 하드웨어 결함율도 증가했다. AWS 같은 일부 클라우드 플랫폼은 단일 장비 신뢰성보다 유연성과 탄력성을 우선으로 처리하게끔 설계됐기 때문에 가상 장비 인스턴스가 별도의 경고 없이 사용할 수 없게 되는 상황이 상당히 일반적이다.

따라서 소프트웨어 내결함성 기술을 사용하거나 하드웨어 중복성을 추가해 전체 장비의 손실을 견딜 수 있는 시스템으로 점점 옮겨가고 있다.

### 소프트웨어 오류
시스템 내 체계적 오류라는 이 결함은 예상하기 더 어렵고 노드 간 상관관계 때문에 상관관계 없는 하드웨어 결함보다 오히려 시스템 오류를 더욱 많이 유발하는 경향이 있다.

- 잘못된 특정 입력이 있을 때 모든 애플리케이션 서버 인스턴스가 죽는 소프트웨어 버그, 예를 들어 리눅스 커널의 버그로 인해 많은 애플리케이션이 일제히 멈춰버린 원인이 된 2012년 6월 30일 윤초의 경우.
- CPU 시간, 메모리, 디스크 공간, 네트워크 대역폭처럼 공유 자원을 과도하게 사용하는 일부 프로세스
- 시스템의 속도가 느려저 반응이 없거나 잘못된 응답을 반환하는 서비스
- 한 구성 요소의 작은 결함이 다른 구성 요소의 결함을 야기하고 차례차례 더 많은 결함이 발생하는 연쇄 장애

소프트웨어의 체계적 오류 문제는 신속한 해결책이 없다. 시스템의 가정과 상호작용에 대해 주의 깊게 생각하기, 빈틈없는 테스트, 프로세스 격리, 죽은 프로세스의 재시작 허용, 프로덕션 환경에서 시스템 동작의 측정, 모니터링, 분석하기와 같은 여러 작은 일들이 문제 해결에 도움을 줄 수 있다. 시스템이 뭔가를 보장하길 기대한다면 수행 중에 이를 지속적으로 확인해 차이가 생기는 경우 경고를 발생시킬 수 있다.  
ex) 메시지 큐에 수신된 메시지 수와 송신된 메시지 수가 같은 경우

### 인적 오류
대규모 인터넷 서비스에 대한 한 연구에 따르면 운영자의 설정 오류가 중단의 주요 원인인 반면 하드웨어 결함은 중단 원인의 10~25% 정도에 그친다고 한다.

사람이 미덥지 않음에도 시스템을 어떻게 신뢰성 있게 만들까? 최고의 시스템은 다양한 접근 방식을 결합한다.

- 오류의 가능성을 최소화하는 방향으로 시스템을 설계하라.
  - 잘 설계된 추상화, API, 관리 인터페이스를 사용하면 "옳은 일"은 쉽게 하고, "잘못된 일"은 막을 수 있다.
  - 인터페이스가 지나치게 제한적이면 사람들은 좋은 점을 잊은 채 제한된 인터페이스를 피해 작업한다. 이런 시스템 설계는 올바르게 작동하게끔 균형을 맞추기 어렵다.
- 사람이 가장 많이 실수하는 장소에서 사람의 실수로 장애가 발생할 수 있는 부분을 분리하라.
  - 특히 실제 데이터를 사용해 안전하게 살펴보고 실험할 수 있지만 실제 사용자에게는 영향이 없는 비 프로덕션 샌드박스를 제공하라.
- 단위 테스트부터 전체 시스템 통합 테스트와 수동 테스트까지 모든 수준에서 철저하게 테스트하라. 자동 테스트는 널리 사용되며 잘 알려져 있다. 특히 정상적인 동작에선 거의 발생하지 않는 코너 케이스를 다루는 데 유용하다.
- 장애 발생의 영향을 최소화하기 위해 인적 오류를 빠르고 쉽게 복구할 수 있게 하라.
  - 설정 변경 내역을 바르게 롤백하고 새로운 코드를 서서히 롤아웃하게 만들고 이전 계산이 잘못된 경우를 대비해 데이터 재계산 도구를 제공하라.
- 성능 지표와 오류율 같은 상세하고 명확한 모니터링 대책을 마련하라.
  - 모니터링은 조기에 경고 신호를 보내줄 수 있고 특정 가정이나 제한을 벗어나는지 확인할 수 있게 한다. 문제 발생 시 metrics는 문제를 분석하는데 매우 중요하다.
- 조작 교육과 실습을 시행하라. 까다롭지만 매우 중요한 측면이다.

### 신뢰성은 얼마나 중요할까?
비즈니스 애플리케이션에서 버그는 생산성 저하의 원인이고 매출에 손실이 발생하고 명성에 타격을 준다는 면에서 많은 비용이 든다.

## 확장성
