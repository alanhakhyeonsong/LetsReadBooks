# Story 22. 어떤 화면이 많이 쓰이는지 알고 싶다.
모니터링 툴이 없는 상황에서 어떤 화면이 많이 호출되었는지를 확인하는 것은 쉽지 않다. 하지만 웹 서버만 있다면 웹 로그를 사용해 시스템을 분석할 수 있다.

## 웹 로그란?
Apache나 Nginx, iPlanet과 같은 모든 웹 서버에 공통적으로 제공되는 기능이 웹 로그다. **서버에 어떤 사용자가 어떤 요청을 하였고, 결과는 어떠한지 파일에 한 줄씩 쌓아 준다.** 사이트의 규모 및 사용자의 양에 따라 로그가 많이 쌓이는 사이트도 있고, 그렇지 않은 사이트도 있다. 일반적인 웹사이트의 경우 사용자가 많으면 기가바이트 단위로 웹 로그가 쌓이게 된다.

웹 로그가 어떻게 구성되어 있는지 아파치 웹 서버의 웹 로그 설정 부분을 확인해보자. `httpd.conf` 파일 내의 로그 포맷(`LogFormat`)이라는 부분을 찾아보면 다음과 같이 되어 있을 것이다.

```
LogFormat "%h %l %u %t \"%r\" %>s %b" common
```

```
127.0.0.1 - - [22/Oct/20XX:14:04:43 +0900] "GET /a.gif HTTP/1.1" 200 2326
```

- `%h`: 서버에 요청을 한 클라이언트(원격 호스트)의 IP 주소. 만약 `HostnameLookups` 설정이 On이라면 IP 주소 대신 호스트 명이 명시된다. 이 설정은 서버를 매우 느리게 할 수 있으므로 추천하는 기능은 아니다. 클라이언트가 프록시 서버를 사용할 경우 클라이언트의 실제 주소가 아닌 프록시 서버의 주소가 이 부분에 표시된다.
- `%l`: `-`로 표시되어 있어 요청한 정보가 없음을 의미한다. `identd`라는 사용자 인식 데몬이 클라이언트에서 동작하고 있을 경우에만 이 정보가 나타난다.
- `%u`: HTTP 인증을 통해 확인된 문서를 요청한 사용자의 ID가 표시된다. 암호화 되지 않은 페이지이기 때문에 이 항목도 앞의 항목과 같이 보통 '?'로 표시된다.
- `%t`: 서버가 요청을 마친 시간이다. 웹 서버에서 해당 요청이 처리되어 종료된 시간으로 보면 된다.
- `%r`: 클라이언트에서 요청한 Request의 정보를 나타낸다. 요청 방식이 가장 처음 나타나며, 요청 주소, 클라이언트에서 사용한 프로토콜의 종류와 버전 순으로 표시된다.
- `%>s`: 서버에서 클라이언트로 보낸 최종 상태 코드를 의미한다. 만약 클라이언트에 해당 파일이 존재한다면 304가 표시된다.
- `%b`: 클라이언트로 전송한 데이터의 크기가 표시된다. 헤더 정보의 크기는 포함되지 않는다.

이 로그 포맷은 표준 포맷으로, 어떤 웹 서버를 사용하더라도 대부분 동일하다. 하지만 성능에 대한 아무런 데이터를 얻을 수 없으므로 다음 두 개의 옵션을 고려하자.

- `%D`: 요청의 처리 시간을 마이크로초 단위로 나타낸다.
- `%T`: 요청의 처리 시간을 초 단위로 나타낸다.

정확한 분석을 위해 주로 `%D` 옵션을 사용하는 것을 권장한다.

무료 웹 로그 분석 툴 중 저자가 그 당시 추천하는 툴은 다음 세 가지라고 한다.

- Analog
- AWStats
- Webalizer

AWStats의 경우 다음과 같은 기능들을 제공한다고 한다.

- 방문 횟수와 방문자 수
- 방문하여 페이지에 머무른 기간 및 마지막 방문일
- 각 시간 및 요일별 방문 페이지 수와 네트워크 사용량
- 방문자의 국가 (GeoIP 활용)
- 가장 많이 본 페이지, 유입 경로 및 마지막 페이지
- 웹 압축 통계
- 사용 OS 및 브라우저 통계
- 방문 검색 로봇의 횟수
- 검색 엔진 및 검색 키워드
- HTTP 에러 목록
- 즐겨찾기 북마크에 추가된 횟수
- 화면 크기

## 요즘은... (내 생각)
이 책이 쓰여진 지 10여년 쯤 됐다. 요즘 대부분의 규모 있는 회사들은 JSP를 사용하지 않고 웹 클라이언트의 경우 Vue, React와 같은 SPA 방식으로 개발하고 서버는 MSA 기반 아키텍처를 도입해 개발하곤 한다. 이러한 요즘 환경에 맞춰 어떤 기술들을 사용하는지 트렌드를 파악해보자.

로깅에 관련해선 ELK 스택, Prometheus, Grafana, 심지어 Kafka Streams 등을 적절하게 조합해서 사용하니 이에 관련된 공부를 해보면 좋을 것 같다.

또한 내가 생각하기엔, 백엔드 개발자의 시각에선 HTTP 프로토콜, 브라우저에서부터 서버로 넘어오는 유효한 정보 값들, 서버 애플리케이션이 배포된 인스턴스 자체의 자원 사용량 등을 명확하게 아는 것이 중요하다고 본다.