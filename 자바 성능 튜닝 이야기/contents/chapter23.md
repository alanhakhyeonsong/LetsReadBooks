# Story 23. 튜닝의 절차는 그때 그때 달라요.
## 성능 튜닝을 위한 아주 기초 법칙
성능 튜닝에 있어 아주 기초적인 법칙은 바로 **암달의 법칙**이다.

암달의 법칙이란, 1 Core에서 20시간 소요되는 작업 중 1시간은 절대 개선할 수 없다면, 20배 이상의 성능 향상은 불가능하다는 법칙이다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/d73323be-ab5a-4ca8-aabd-9b6dc0b0f7ca)

- P: 개선 가능한 부분의 비율
- S: 개선된 정도

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/ea8c01ea-e2c0-4e49-8f07-4b40c03a3374)

어떤 프로그램이라 할지라도 위와 같은 패턴을 보일 수 밖에 없으며, 성능 개선에는 한계가 생길 수 밖에 없다. 아무리 최적화된 시스템이라 할지라도 생각지도 못한 부분의 성능 저하는 발생할 수 밖에 없다.

## 성능 튜닝 step by step
저자의 작업 절차는 다음과 같다고 한다. 절대적인 규칙은 아니지만, 경험에 의거하면 그렇다고 한다.

1. 원인 파악
2. 목표 설정
3. 튜닝 실시
4. 개선율 확인
5. 결과 정리 및 반영

### 원인 파악
성능 저하가 발생하는 원인을 파악하는 단계다.

원인 파악을 잘못하면 매우 많은 시간 낭비가 발생할 것이다. 따라서, 어디가 병목인지 확실히 파악하여 원인을 찾아야 한다. 주변에 전문가가 있다면 그들에게 부탁하는 것도 좋은 방법이다. 원인이 아닌 곳을 원인으로 판단하여 진행하면, 첫 단추를 잘못 꿴 것이기에 아무리 결과 정리까지 끝냈다고 하더라도 처음부터 다시 튜닝 작업을 해야 하는 상황도 발생한다.

### 목표 설정
성능 튜닝의 목표를 설정한다. 반드시 설정할 필요는 없지만, 성능 개선뿐만 아니라 향후 유지보수까지 모두 고려해서 목표를 설정하는 것이 좋다.

### 튜닝 실시
코드를 최적화하며 튜닝하는 단계다.

가장 좋은 방법은 프로파일링 툴이나 APM과 같은 툴을 사용하는 것이고, 개선이 얼마나 되었는지를 확인하려면 JMH나 캘리퍼와 같은 성능 비교 도구를 사용하는 것도 큰 도움이 될 수 있다.

### 개선율 확인
튜닝을 실시한 후 얼마나 개선되었는지를 확인하는 단계다.

개선율을 확인한 다음, 결과가 만족스럽지 않은 경우엔 튜닝 실시 단계로 다시 넘어가서 진행을 해야 한다. 간혹, 원인을 잘못 판단했을 경우 개선율이 아주 낮게 나올 수 밖에 없다. 엉뚱한 곳에서 작업을 할 수도 있으니, 때에 따라선 원인 파악부터 다시 해야 한다.

### 결과 정리 및 반영
튜닝한 결과들을 정리하고, 실제 운영되는 시스템에 반영되는 단계다.

만약 정리가 반드시 필요 없다 하더라도, 아주 간단하게 어딘가에 정리하는 습관을 가져가는 것이 좋다. (위키나 노션에 정리해두자.)

## 성능 튜닝의 비법
저자가 생각하는 성능 튜닝의 비법은 다음과 같다고 한다.

- 하나만 보지 말아라.
- 큰 놈을 없애라.
- 깊게 알아야 한다.
- 결과 공유는 선택이 아닌 필수!

### 하나만 보지 말아라
우리 모두가 알고 있는 병목 지점은 이 세상에 있는 병목 지점의 일부분일 뿐이다. 예를 들어, WAS의 스레드 개수 때문에 고생한 개발자가 있다 가정해보자. 그가 시스템을 운영하다 성능상 이슈가 있으면 무엇을 제일 먼저 볼까? 당연히 WAS의 스레드 개수를 먼저 확인해 볼 것이다. 이 사람이 높은 직급이 되어 관리자가 된다면, 어떤 문제가 있으면 무조건 스레드 문제 때문일 것이라 단언할 수 있다.

하지만, 성능상 문제를 발생 시킬 수 있는 대상은 아주 많다. 저자가 알고 있는 병목 대상 목록은 다음과 같다고 한다.

|대상|세부 대상|
|--|--|
|서버 장비|CPU, Network, Disk, Memory 등|
|서버 OS|OS 커널, OS 설정, 수행중인 프로세스 등|
|자바 애플리케이션|스레드 풀 설정, DB Connection Pool 설정, Cache 설정, GC 설정, Heap 크기 설정, 검증되지 않은 프레임워크의 버그, 개발된 애플리케이션 등|
|웹 서버|프로세스 개수 설정, Connector 설정, 개발된 모듈의 버그 등|
|네트워크|사용자의 네트워크 종류, 사용자의 위치, L4 및 Switch 등 네트워크 장비, 방화벽 등|
|클라이언트|클라이언트 장비의 CPU, Network, Disk, Memory, OS 등의 성능, 클라이언트 애플리케이션, 클라이언트 장비에서 수행 중인 프로세스 등|

이 사항들도 더 자세히 들어가 보면 엄청나게 많은 경우의 수가 발생할 것이다. **성능상 이슈가 있을 때는 절대로 하나만 보면 안 된다. 전체를 봐야 한다.**

### 큰 놈을 없애라
잔챙이 백날 튜닝해봐야 효과 없다.

- 1초 걸리는 애플리케이션에서 0.2초 소요되는 메서드 하나를 튜닝해서 0.00001초가 된다해서 20%의 성능 개선일 뿐이다. 가장 큰 성능 저하가 발생하는 부분을 찾아 튜닝해야 한다.
- 1명의 요청을 할 때 응답이 0.1초로 매우 빠르다. 하지만, 운영 상황에서 그 속도가 나온다는 보장은 없다.

**부하 테스트 툴이나 간단히 스레드를 만들어 부하를 주어 성능 측정을 해 봐야만 한다.** 모든 애플리케이션을 그렇게 측정할 필요는 없지만, **해당 애플리케이션 요청의 상위 80%에 해당하는 프로그램들은 반드시 그렇게 측정하고 문제를 잡아야만 한다.**

**성능 튜닝을 하다 보면 중심이 되는 라이브러리에 문제가 발생하는 경우도 적지 않다.** 이 경우 선택지는 두 가지다.

- 해당 라이브러리를 튜닝
- 다른 것으로 교체

개발이 막바지에 다다랐을 때는 라이브러리를 교체하는 비용이 만만치 않게 될 수도 있다. 이런 경우가 발생하는 것을 방지하는 가장 좋은 방법은 **시스템의 코어 부분이 개발 완료되었을 때 성능 테스트를 통해서 사용중인 라이브러리의 성능을 검증하는 것이다.** 대부분의 프로젝트는 개발을 시작할 때 **코어가 되는 부분을 먼저 개발하고, 그 다음에 관련된 기능들을 개발한다.** 이 절차를 따르는 것을 권장한다.

### 깊게 알아야 한다
개발 언어, OS, DB, Network, 서버 등 대충 알면 대충 튜닝할 수 밖에 없다. 하지만, 이 모든 것의 전문가가 되기는 어렵다. 그러니 **하나라도 전문가가 되어야 한다.**

생소한 언어로 개발하면 최적화는 신경도 못쓰고, 어떻게든 기능만 잘 되도록 개발할 것이다. 마찬가지로 OS 설정이나 DB 쿼리 작성 등의 작업도 제대로 모르면 구글링을 통해 대충 설정하고, 쿼리도 그저 수행될 수 있게만 작성해 버릴 수도 있다. 전체적인 역량은 키우되, 특정 레벨이 넘어가면 한 가지를 딥다이브하자.

### 결과 공유는 선택이 아닌 필수
결과를 잘 정리하는 것은 매우 중요하다. 잘못하면 오랜 기간 동안 힘들게 작업한 것이 인정받지 못할 수도 있다. 꼭 포함되어야 하는 내용은 다음과 같다.

- 개요: 튜닝을 실시한 배경
- 튜닝 환경: 튜닝을 실시하고 성능을 측정한 서버 및 툴에 대한 상세한 내용
- 튜닝 결과: 튜닝 전과 후의 결과를 비교
- 결론: 어느 부분을 어떻게 변경하는 것이 가장 큰 효과를 줄지, 튜닝 작업을 진행한 담당자의 의견 등을 포함

튜닝 결과를 정리할 때 몇 가지 유의사항이 있다.

- 확실한 결과 위주로 포함하자.
  - '이렇게 변경할 경우 성능 개선이 될 수도 있음'과 같은 불확실한 워딩은 좋지 않은 습관이다.
  - 기존 대비 얼마나 성능 개선이 이루어졌는지를 수치로 보여주는 것만큼 확실한 것은 없다.
- 개선 효과가 가장 큰 것부터 나열하자.
- 개발한 사람의 심기를 나쁘게 하지 말자.
  - 튜닝도 사람이 하고, 튜닝 대상이 되는 프로그램도 사람이 만든다. 프로그램을 작성한 사람을 비하하면서 결과를 정리할 경우 그 개발자와는 영원히 적이 될 수도 있다.
  - 최대한 존중하며 결과를 정리해야 한다. 완곡한 표현을 사용하자.

### 그래프를 그릴 때 유의사항
그래프는 신중하게 생각하며 그리는 게 좋다. 대충 의미 없이 그래프 30개를 나열하는 것보단, 그래프 하나로 모든 상황을 볼 수 있도록 그리는 것만큼 예술적인 것은 없다.

- 전반적으로, 그래프의 타이틀은 반드시 추가하자. 그렇지 않으면 비슷한 다른 그래프와 혼동될 수도 있다.
  - 그래프의 라벨은 가능하면 X축 하단에 넣자. 그래야 그래프의 내용을 보다 크게 보여줄 수 있다.
  - 산포도를 보여줄 때, 데이터를 나타내는 각 점은 되도록이면 작게 표현하자. 그래야 데이터가 어떻게 분포되어 있는지를 쉽게 볼 수 있다.
- Y축을 그릴 때
  - 정수 값일 경우 1,000 단위에 콤마를 추가하자.
  - 소수까지 내려가는 값일 경우 적어도 3자리를 보여 주자.
  - 주 단위를 표시하는 경우 그래프 내에 주 단위가 4개 이상 표시되지 않는 것이 좋다.
- X축을 그릴 때
  - X축의 주 단위는 10개 내외로 보여 주는 것이 좋다.
  - 주 단위를 선으로 보여 줄지, 눈금으로만 보여 줄지는 상황에 맞게 결정하자.