# 2장. 리팩터링 원칙
## 리팩터링 정의
- 리팩터링: 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법
- 결국 동작을 보존하는 작은 단계들을 거쳐 코드를 수정하고, 이러한 단계들을 순차적으로 연결하여 큰 변화를 만들어내는 일이다.
- 리팩터링은 성능 최적화와 비슷하다. 둘 다 코드를 변경하지만 프로그램의 전반적인 기능은 그대로 유지한다.
- 리팩터링의 목적은 코드를 이해하고 수정하기 쉽게 만드는 것이다.

## 두 개의 모자
- 소프트웨어 개발의 목적: 기능 추가 vs 리팩터링
  - 기존 코드는 절대 건드리지 않고 새 기능을 추가하기만 한다. 진척도는 테스트를 추가해서 통과하는지 확인하는 방식으로 측정한다.
  - 기능 추가는 절대 하지 않기로 다짐한 뒤 오로지 코드 재구성에만 전념한다.
- 새 기능 추가 → 리팩터링 → 코드 구조가 어느 정도 개선되면 다시 기능 추가를 이어간다.

## 리팩터링하는 이유
모든 문제점을 해결하는 만병통치약은 절대 아니다.

- 리팩터링하면 소프트웨어 설계가 좋아진다.
  - 코드 구조가 무너지는 속도는 순식간이다. 리팩터링을 통해 코드의 구조를 지탱하자.
- 소프트웨어를 이해하기 쉬워진다.
  - 나중에 해당 코드를 다룰 개발자를 배려하여 이해하기 쉽게 만들자. 다른 사람이 곧 내가 될 수 있다.
  - 기억할 필요가 있는 것들은 최대한 코드에 담자.
- 버그를 쉽게 찾을 수 있다.
  - 리팩터링하면 코드가 하는 일을 깊이 파악하게 되면서 새로 깨달은 것을 곧바로 코드에 반영하게 된다.
  - 프로그램의 구조를 명확하게 다듬으면 그냥 '이럴 것이다'라고 가정하던 점들이 분명히 드러나는데, 버그를 지나치려야 지나칠 수 없을 정도까지 명확해진다.
- 프로그래밍 속도를 높일 수 있다.
  - 코드 개발 속도를 높일 수 있다.
  - 기능을 추가하면 할 수록 기존 코드베이스에 잘 녹여낼 방법을 찾는 데 드는 시간이 늘어난다. 게다가 버그가 발생하는 일이 잦고, 해결하는 시간 또한 길어진다.
  - 내부 설계가 잘 된 소프트웨어는 새로운 기능을 추가할 지점과 어떻게 고칠지를 쉽게 찾을 수 있다.
  - 모듈화가 잘 되어 있으면 전체 코드베이스 중 작은 일부만 이해하면 된다.

## 언제 리팩터링해야 할까?
3의 법칙
> 1. 처음에는 그냥 한다.
> 2. 비슷한 일을 두 번째로 하게 되면, 일단 계속 진행한다.
> 3. 비슷한 일을 세 번째 하게 되면 리팩터링한다.

- 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기
  - 코드베이스에 기능을 새로 추가하기 직전이 가장 좋은 시점이다.
  - 함수 매개변수화하기
  - 버그를 잡을 때도 마찬가지다.
    - 오류를 일으키는 코드가 세 곳에 복제되어 퍼져 있다면, 우선 한 곳으로 합치는 편이 작업하기 편하다.
    - 질의 코드에 섞여 있는 갱신 로직을 분리하면 두 작업이 꼬여 생기는 오류를 크게 줄일 수 있다.
- 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기
  - 코드를 파악할 때마다 코드의 의도가 더 명확하게 드러나도록 리팩터링할 여지는 없는지?
  - 내가 이해한 것을 코드에 반영하여 더 오래 보존하도록, 동료들도 알아보기 쉽도록.
- 쓰레기 줍기 리팩터링
  - 간단히 수정할 수 있는 것은 즉시 고치고, 시간이 좀 걸리는 일은 짧은 메모만 남긴 다음, 하던 일을 끝내고 나서 처리한다.
- 계획된 리팩터링과 수시로 하는 리팩터링
  - 보기 싫은 코드를 발견하면 리팩터링하자. 그런데 잘 작성된 코드 역시 수많은 리팩터링을 거쳐야 한다.
  - 무언가 수정하려 할 때는 먼저 수정하기 쉽게 정돈하고 그런 다음 쉽게 수정하자.
- 오래 걸리는 리팩터링
  - 팀 전체가 리팩터링에 매달리는 데는 회의적이다. 그보단 주어진 문제를 몇 주에 걸쳐 조금씩 해결해나가는 편이 효과적일 때가 많다.
  - 라이브러리를 교체할 때는 기존 것과 새 것 모두를 포용하는 추상 인터페이스부터 마련한다. 기존 코드가 이 추상 인터페이스를 호출하도록 만들고 나면 라이브러리를 훨씬 쉽게 교체할 수 있다. (추상화로 갈아타기)
- 코드 리뷰에 리팩터링 활용하기
  - 코드 리뷰는 개발팀 전체에 지식을 전파하는 데 좋다.
  - 다른 이의 코드를 리뷰하는 데 도움이 되며, 코드 리뷰의 결과를 더 구체적으로 도출하는 데에도 도움된다.
- 관리자에게는 뭐라고 말해야 할까?
  - 프로 개발자의 역할은 효과적인 소프트웨어를 최대한 빨리 만드는 것이다. 리팩터링하면 소프트웨어를 빠르게 만드는 데 아주 효과적이다.
  - 프로 개발자에게 주어진 임무는 새로운 기능을 빠르게 구현하는 것이고, 가장 빠른 방법은 리팩터링이다.
- 리팩터링하지 말아야 할 때
  - 지저분한 코드를 발견해도 굳이 수정할 필요가 없을 때. 내부 동작을 이해해야 할 시점에 리팩터링해야 효과를 제대로 볼 수 있다.
  - 처음부터 새로 작성하는 게 쉬울 때.

## 리팩터링 시 고려할 문제
- 새 기능 개발 속도 저하
  - 대부분은 리팩터링을 더 자주 하도록 노력해야 한다.
  - 클린 코드나 바람직한 엔지니어링 습관처럼 도적적인 이유로 정당화하는 것은 위험하다. 본질은 오로지 경제적인 이유로 하는 것이다.
- 코드 소유권
  - 느슨한 코드 소유권을 정하고, 변경 사항 커밋을 클라이언트를 관리하는 쪽에서 승인하는 방식으로 처리한다.
  - 코드 소유권을 엄격히 제한하는 방식과 완전히 풀어서 변경을 통제하기 어려운 방식을 절충하면 대규모 시스템 개발 시 잘 어울린다.
- 브랜치
  - CI를 적용하기 위해선 생각해야 하는 부분은 거대한 기능을 짧게 쪼개서 통합이 잘되도록 하는 것과 완료되지 않은 기능이 시스템 전체를 망치지 않도록 하는 것이다.
  - feature flag
- 테스팅
  - 핵심은 오류를 재빨리 잡는 데 있다.
  - 대부분 자가 테스트 코드를 마련해야 한다.
- 레거시 코드
  - 레거시 시스템을 파악할 때 굉장히 도움된다.
  - 테스트 보강은 반드시 필요하다.
  - 서로 관련된 부분끼리 나눠서 하나씩 공략하는 방식으로 처리한다. 코드의 한 부분을 훑고 넘어갈 때마다 예전보다 조금이라도 개선하려고 노력한다.
  - 자주 보는 부분을 더 많이 리팩터링한다.
- 데이터베이스
  - 프로덕션 환경에 여러 단계로 나눠 릴리스하는 것이 대체로 좋다. 이렇게 하면 프로덕션 환경에서 문제가 생겼을 때 변경을 되돌리기 쉽다.
    - 필드 이름을 바꾼다면, 첫 번째 커밋에선 새로운 데이터베이스 필드를 추가만 하고 사용하지는 않는다.
    - 기존 필드와 새 필드를 동시에 업데이트하도록 설정한다.
    - 데이터베이스를 읽는 클라이언트들을 새 필드를 사용하는 버전으로 조금씩 교체한다.
    - 버그 해결 및 클라이언트 교체 작업을 모두 끝냈다면, 더는 필요가 없어진 예전 필드를 삭제한다.