# 21장. 로깅과 사용 추적
거의 모든 서버와 프락시는 처리했던 HTTP 트랜잭션을 요약해서 기록해 놓는다. 그 이유는 사용 추적, 보안, 청구, 에러 탐지 등 여러가지의 이유가 있다.

## 로그란 무엇인가?
대체로 로깅을 하는 이유는 두 가지다.

- 서버나 프락시의 문제를 찾기 위해
- 웹 사이트 접근 통계를 내기 위해

HTTP 트랜잭션의 모든 헤더를 로깅할 순 있지만, 하루에 트랜잭션을 수백만개나 처리하는 서버나 프락시에서 모든 데이터를 그대로 로깅하면 감당하기 힘들어진다. 별 연관성이 없고 다시 볼 일도 없는 데이터만 로깅하는 것이다. 보통은 트랜잭션의 기본적인 항목들만 로깅한다.

- HTTP 메서드
- 클라이언트와 서버의 HTTP 버전
- 요청받은 리소스의 URL
- 응답의 HTTP 상태 코드
- 요청과 응답 메시지의 크기(모든 엔터티 본문을 포함)
- 트랜잭션이 일어난 시간
- Referer와 User-Agent 헤더 값

## 로그 포맷
- 상용 혹은 오픈 소스 HTTP 애플리케이션은 대부분, 표준 로그 포맷을 한 개 이상 지원한다.
- 애플리케이션이 더 많은 표준 포맷을 지원하고 관리자가 그것을 사용함으로써 얻는 이점이 많다.

### 일반 로그 포맷(Common Log Format)
가장 일반적인 포맷이며, 많은 서버들이 기본으로 사용한다.

|필드|설명|
|--|--|
|remotehost|요청한 컴퓨터의 호스트 명 혹은 IP주소|
|username|ident 검색을 수행했다면, 인증된 요청자의 사용자 이름|
|auth-username|인증을 수행했다면, 인증된 요청자의 이름|
|timestamp|요청 날짜와 시간|
|request-line|HTTP 요청의 행을 그대로 기술|
|response-code|응답으로 보내는 HTTP 상태 코드|
|response-size|응답 엔터티의 Content-Length, 아무런 엔터티를 반환하지 않으면 값이 0이 된다.|

```
209.1.32.44 - - [03/Feb/1999:14:15:00 -0400] "GET / HTTP/1.0" 200 1024
http-guide.com - dg [03/Feb/1999:14:15:00 -0400] "GET / HTTP/1.0" 200 477
http-guide.com - dg [03/Feb/1999:14:15:00 -0400] "GET /foo HTTP/1.0" 404 0
```

이 예제에는 다음과 같은 필드가 있다.

|필드|엔트리1|엔트리2|엔트리3|
|--|--|--|--|
|remotehost|209.1.32.44|http-guide.com|http-guide.com|
|username|없음|없음|없음|
|auth-username|없음|dg|dg|
|timestamp|03/Feb/1999:14:15:00 -0400|03/Feb/1999:14:15:00 -0400|03/Feb/1999:14:15:00 -0400|
|request-line|GET /HTTP/1.0|GET /HTTP/1.0|GET /foo HTTP/1.0|
|response-code|200|200|404|
|response-size|1024|477|0|

이 외에 혼합 로그 포맷, 넷스케이프 확장 로그 포맷, 스퀴드 프락시 로그 포맷은 책을 참고하도록 하자.

## 적중 계량하기
- 원 서버는 결산을 하기 위해 상세 로그를 지원한다.
- 로깅은 클라이언트가 웹서버에 직접 방문했을 때 유용한 정보를 추적하는 데 유용하다.
- 하지만 클라이언트와 서버 사이에 캐시가 있어서, 많은 요청이 서버까지 오지 않고 캐시되어 있는 리소스로 처리되고 끝난다.
- 캐시는 수많은 HTTP 요청을 처리하므로, 요청이 원 서버까지 오지 않더라도 정상적으로 처리될 수 있어서, 클라이언트가 콘텐츠에 접근했다는 기록을 남기지 않아 결국엔 로그 파일에 누락을 발생시킨다.
- 캐시 파기는 콘텐츠 생산자가 의도적으로 특정 콘텐츠가 캐시되지 않게 만드는 것이므로, 이 콘텐츠에 대한 모든 요청은 원 서버로 간다.
  - 로깅을 문제없이 하지만, 요청에 대한 응답 속도는 느려지고 원 서버와 네트워크의 부하가 가중된다.
- 적중 계량 규약은 HTTP의 확장으로, 캐시가 정기적으로 캐시 접근 통계를 원 서버에 보고하도록 한다.
  - 완벽한 해결책은 아니지만, 적어도 서버가 원하는 통계 정보를 받아볼 수 있는 방법을 제공한다.

## 개인 정보 보호에 대해
실제 로깅은 서버와 프락시에서 수행하는 관리 기능이므로, 모든 것이 사용자의 트랜잭션에 적용된다. 사용자는 자신의 HTTP 트랜잭션이 로깅되고 있다는 것을 모를 수 있다. 사실 많은 사용자가 웹에 있는 콘텐츠에 접근하려고 HTTP 프로토콜을 사용한다는 것조차 모른다.

웹 애플리케이션 개발자와 관리자는 사용자의 HTTP 트랜잭션을 추적하고 있다는 것을 유념하고 있어야 한다. 이 정보는 나쁜 목적으로 사용될 수 있다. 로깅하는 웹 서버와 프락시는 최종 사용자의 개인 정보를 보호하는데 신경을 많이 써야 한다.

다시 말해, 로깅은 관리자와 개발자에게 매우 유용한 도구지만 로깅을 당하는 사용자들의 인지나 허가가 없음녀 로깅이 사생활 침해가 된다는 것을 유념해야 한다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/a017423f-d040-439b-9614-8362dd645202)
