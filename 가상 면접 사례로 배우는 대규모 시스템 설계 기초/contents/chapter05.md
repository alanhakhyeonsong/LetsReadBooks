# 5장. 안정 해시 설계
수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. 안정 해시는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.

## 해시 키 재배치(rehash) 문제
- N개의 캐시 서버가 있다고 할 때, 이 서버들에 부하를 균등하게 나누는 보편적인 방법은 아래의 해시 함수를 사용하는 것이다.

```
# N은 서버의 개수
serverIndex = hash(key) % N
```

이 방법은 서버 풀(server pool)의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 동작한다. 하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.

장애가 발생한 서버에 보관되어 있는 키 뿐만이 아닌 대부분의 키가 재분배되는데, 대부분 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 된다. 그 결과 대규모 캐시 미스가 발생하게 될 것이다. 안정 해시는 이 문제를 효과적으로 해결하는 기술이다.

## 안정 해시(Consistent Hash)
- 안정 해시는 해시 테이블의 크기가 조정될 때 평균적으로 오직 `k/n` 개의 키만 재배치하는 해시 기술이다. (k = 키의 개수, n = 슬롯 개수)
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키에 저장될 서버다.
- 레디스의 데이터를 어플리케이션 레이어에서 분산 시킬 때 사용할 수 있다. ([영상 링크](https://youtu.be/mPB2CZiAkKM?t=3580) 참고)

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/ad4d9dda-5d83-4781-8d37-a83e3e2514e8)

- 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버다.
  - Nick Smith 는 Partition 1
  - Steven King 은 Partition 2

#### 서버 추가
- 서버를 중간에 추가하여 Partition 4가 생겼을 경우
  - Partition 4의 위치가 Mary Drake 와 Nick Smith 의 사이에 위치하게 될 경우, 리밸런싱은 Mary Drake 만 이루어지면 된다.

#### 서버 제거
- Partition 3이 제거된 경우
  - Alex Hue와 Josh Ernst만 Partition 1로 리밸런싱되면 된다.

### 안정 해시의 문제점
- 서버가 추가되거나 삭제될 때, 리밸런싱이 이루어지면서 해당 서버에 키가 집중되기 때문에 파티션의 크기를 균등하게 유지하는 것이 불가능하다.
- 특정 상황에 따라 키가 균등하게 분포되지 않을 수도 있다.

이 문제를 해결하기 위해 제안된 기법이 가상 노드(virtual node) 또는 복제(replica)라 불리는 기법이다.

## 가상 노드 (Virtual Node)
- 가상 노드는 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
- 가상 노드의 개수를 늘리면 표준 편차가 작아져서 키의 분포도는 점점 균등해진다.
  - 100 ~ 200개의 가상 노드를 사용했을 경우 표전 편차 값은 평균의 5%(가상 노드가 200개인 경우)에서 10%(가상-노드가 100개인 경우) 사이다.
- 가상 노드의 개수를 더 늘리면 표준 편차의 값은 더 떨어지지만 가상 노드 데이터를 저장할 공간이 더 많이 필요해지게 된다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/cd03295d-b10c-46b3-9e18-268f545ffb60)

[참고](https://liuzhenglaichn.gitbook.io/system-design/advanced/consistent-hashing)

## 마치며
이번 장에서는 안정 해시가 왜 필요하며 어떻게 동작하는지를 자세히 살펴보았다. 안정 해시의 이점은 다음과 같다.
- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟(hotspot) 키 문제를 줄인다. 특정한 샤드(shard)에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있다. 안정 해시는 데이터를 좀 더 균등하게 분배하므로 이런 문제가 생길 가능성을 줄인다.

안정 해시의 유명한 몇 가지 사례는 다음과 같다.
- AWS DynamoDB의 파티셔닝 관련 컴포넌트
- Apache Cassandra 클러스터에서의 데이터 파티셔닝
- Discord 채팅 애플리케이션
- Akamai CDN
- Meglev 네트워크 부하 분산기