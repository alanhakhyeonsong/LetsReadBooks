# 14장. 유튜브 설계
2020년에 조사된 유튜브에 대한 놀라운 통계자료 몇 가지를 살펴보자.

- 월간 능동 사용자 수: 20억
- 매일 재생되는 비디오 수: 50억
- 미국 성인 가운데 73%가 유튜브 이용
- 5000만 명의 창작자
- 유튜브 광고 수입은 2019년 기준 150억 달러이며 이는 전년도 대비 36%가 증가한 수치
- 모바일 인터넷 트래픽 가운데 37%를 유튜브가 점유
- 80개 언어로 이용 가능

## 1단계: 문제 이해 및 설계 범위 확정
유튜브에는 단순히 비디오를 보는 것 말고도 댓글, 비디오 공유 및 좋아요, 개인 playlist, 채널과 구독 등 다양한 기능이 있다. 적절한 질문을 통해 설계 범위를 줄여보자.

- 가장 중요한 기능? → 비디오를 올리는 기능과 시청하는 기능
- 클라이언트 지원 종류? → 모바일 앱, 웹 브라우저, 스마트 TV
- 일간 능동 사용자 수? → 500만
- 사용자가 이 제품에 평균적으로 소비하는 시간은 얼마인가? → 30분
- 다국어 지원? → 어떤 언어로도 이용 가능해야 함
- 비디오 해상도? → 현존하는 비디오 종류와 해상도 대부분을 지원해야 함
- 암호화 필요? → O
- 비디오 파일 크기 제한? → 최대 1GB로 제한하자
- AWS 등의 클라우드 서비스 활용 가능

이번 장에는 아래와 같은 기능을 갖는 비디오 스트리밍 서비스 설계에 초점을 맞출 것이다.

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 가능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 안정성
- 지원 클라이언트: 모바일 앱, 웹 브라우저, 스마트 TV

개략적 규모 추정치는 다음과 같다.

- 일간 능동 사용자: 500만
- 한 사용자는 하루에 평균 5개의 비디오를 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = 500만 * 10% * 300MB = 150TB
- CDN 비용
  - 클라우드 CDN을 통해 비디오를 서비스할 경우 CDN에서 나가는 데이터의 양에 따라 과금
  - AWS CloudFront를 CDN 솔루션으로 사용할 경우, 100% 트래픽이 미국에서 발생한다 가정하면 1GB당 0.02 달러의 요금이 발생한다.
  - 문제를 단순화하기 위해 비디오 스트리밍 비용만 따지도록 한다.
  - 매일 발생하는 요금은 500만 * 5비디오 * 0.3GB * 0.02달러 = 15만 달러이다.

이 추정 결과에 따르면 CDN을 통해 비디오를 서비스하면 비용이 엄청나다. 이 비용을 줄이는 방법에 대해 상세 설계를 진행하면서 보다 자세히 알아보겠다.

## 2단계: 개략적 설계안 제시 및 동의 구하기
개략적으로 보면 이 시스템은 다음 세 개 컴포넌트로 구성된다.

- 단말(client): 컴퓨터, 모바일 폰, 스마트 TV
- CDN: 비디오는 CDN에 저장한다. 재생 버튼을 누르면 CDN으로부터 스트리밍이 이루어진다.
- API 서버: 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다.
  - 피드 추천, 비디오 업로드 URL 생성, 메타데이터 데이터베이스와 캐시 갱신, 사용자 가입 등

면접관이 다음의 두 영역을 설계해 줄 것을 요청했다고 가정하자. 이 각각을 개략적으로 설계해보자.
- 비디오 업로드 절차
- 비디오 스트리밍 절차

### 비디오 업로드 절차
![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/35811c22-cf22-4cbf-9218-7dbe11171cef)

이 설계안은 다음의 컴포넌트들로 구성되어 있다.

- 사용자
- 로드밸런서: API 서버 각각으로 고르게 요청을 분산한다.
- API 서버
- 메타데이터 데이터베이스: 비디오의 메타데이터를 보관한다. 샤딩과 다중화를 적용하여 성능 및 가용성 요구사항을 충족한다.
- 메타데이터 캐시: 성능을 높이기 위해 비디오 메타데이터와 사용자 객체는 캐시한다.
- 원본 저장소: 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB, Binary Large Object Storage) 시스템
- 트랜스코딩 서버: 비디오 트랜스코딩은 비디오 인코딩이라 부르기도 하는 절차로, 비디오의 포맷을 변환하는 절차다. 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- 트랜스코딩 비디오 저장소: 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- CDN: 비디오를 캐시하는 역할을 담당.
- 트랜스코딩 완료 큐: 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐
- 트랜스코딩 완료 핸들러: 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들이다.

비디오 업로드는 다음 두 프로세스가 병렬적으로 수행된다고 보면 된다.

### 프로세스 a: 비디오 업로드
![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/3c48d9b9-da38-4dfe-977f-fdc6188b3534)

1. 비디오를 원본 저장소에 업로드한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스코딩이 완료되면 아래 두 절차가 병렬적으로 수행된다.  
  3a. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
  3b. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.  
    3a.1. 트랜스코딩이 끝난 비디오를 CDN에 올린다.  
    3b.1. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.  
    3b.1.a, 3b.1.b. 완료 핸들러가 메타데이터 데이터베이스와 캐시를 갱신한다.
4. API 서버가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 되었음을 알린다.

### 프로세스 b: 메타데이터 갱신
![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/2611e2e4-283f-4761-9267-dfadc50b664f)

- 원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.
- 메타데이터에 포함된 데이터는 파일 이름, 크기, 포맷 등의 정보가 들어있다.
- API 서버는 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트 한다.

### 비디오 스트리밍 절차
유튜브에서 비디오 재생버튼을 누르면 스트리밍은 바로 시작되며 비디오 다운로드가 완료되어야 영상을 볼 수 있다거나 하는 불편함은 없다.

- 다운로드: 비디오를 단말로 내려 받는 것
- 스트리밍: 단말기가 원격지의 비디오로부터 지속적으로 비디오 스트림을 전송 받아 영상을 재생하는 것

> 📌 스트리밍 프로토콜(streaming protocol)
> 
> 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법이다. 널리 쓰이는 프로토콜로는 다음과 같은 것이 있다.
> - MPEG-DASH(Moving Picture Experts Group-Dynamic Adaptive Streaming over HTTP)
> - Apple HLS(HTTP Liver Streaming)
> - Microsoft Smooth Streaming
> - Adobe HTTP Dynaming Streaming

다만 기억해야 하는 것은 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다는 것이다. 따라서 비디오 스트리밍 서비스를 설계할 때는 서비스의 용례에 맞는 프로토콜을 잘 골라야 한다.

비디오는 CDN에서 바로 스트리밍된다. 사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당할 것이다. 따라서 전송 지연은 아주 낮다.

## 3단계: 상세 설계