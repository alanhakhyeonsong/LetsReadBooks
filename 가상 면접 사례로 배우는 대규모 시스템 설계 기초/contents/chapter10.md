# 10장. 알림 시스템 설계
알림 시스템을 갖춘 애플리케이션은 최신 뉴스, 제품 업데이트, 이벤트, 선물 등 고객에게 중요할 만한 정보를 비동기적으로 제공한다. 알림 시스템은 단순히 모바일 푸시 알림에 한정되지 않는다. 책에선 모바일 푸시 알림, SMS 메시지, 이메일의 3가지로 분류한다.

## 1단계: 문제 이해 및 설계 범위 확정
Q. 어떤 종류의 알림?
- 푸시 알림, SMS 메시지, 이메일

Q. 실시간 시스템인가?
- 연성 실시간 시스템(soft real-time)
- 알림은 가능한 한 빨리 전달되어야 하지만 시스템에 높은 부하가 걸렸을 때 약간의 지연은 무방하다.

Q. 지원 단말?
- iOS, Android, 랩톱/데스크톱 지원

Q. 사용자에게 보낼 알림을 누가 만들 수 있는지?
- client application
- server 측에서 스케줄링

Q. 사용자가 알림을 받지 않도록 설정할 수 있는지?
- 사용자가 알림을 허용하지 않으면 알림을 받지 않음

Q. 하루에 몇 건의 알림을 보낼 수 있는지?
- 천만 건의 모바일 푸시 알림
- 백만 건의 SMS 메시지
- 500만 건의 이메일

## 2단계: 개략적 설계안 제시 및 동의 구하기
### 알림 유형별 지원 방안
#### iOS 푸시 알림
- 알림 제공자 → APNS → iOS 단말
- 알림 제공자
  - 알림 요청을 만들어 APNS로 보내는 주체
  - 단말 토큰, 페이로드 데이터가 필요하다.
- APNS: 애플이 제공하는 원격 서비스로 푸시 알림을 iOS 장치로 보내는 역할을 담당한다.

#### 안드로이드 푸시 알림
- 알림 제공자 → FCM(Firebase Cloud Messaging) → 안드로이드 단말

#### SMS 메시지
- 알림 제공자 → SMS 서비스(NHN Cloud Notification, ...) → SMS 수신 단말

#### 이메일
- 알림 제공자 → 이메일 서비스(Sendgrid, Mailchimp, Google, Naver, ...) → 이메일 수신 단말

### 연락처 정보 수집 절차
알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다. 사용자가 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 DB에 저장한다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/de1eb87e-33c0-4878-8ed1-4af15a2a5510)

### 알림 전송 및 수신 절차
#### 개략적 설계안 (초안)
- 알림을 요청하는 N개의 서비스: 서비스 각각은 마이크로서비스 또는 크론잡 등 일 수 있다.
- 알림 시스템: 알림 전송을 위한 API를 제공해야 하고, 제3자 서비스에 전달할 알림 페이로드를 만들어 낼 수 있어야 한다. 우선은 1개 서버만 사용하는 시스템이라고 가정해보자.
- 제3자 서비스: 사용자에게 알림을 실제로 전달하는 역할을 한다. **확장성**을 염두해 설계해야 한다. 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 한다는 뜻이다.

이 설계에는 몇 가지 문제가 있다.
- SPOF: 알림 서비스에 서버가 하나밖에 없는 구조
- 규모 확장성: 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, DB나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
- 성능 병목: 알림을 처리하고 보내는 것은 많은 자원이 필요로 하는 작업일 수 있다. 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있다.

#### 개선된 설계
초안의 문제점을 통해 다음과 같은 방향으로 개선해 보도록 하자.
- DB와 캐시를 알림 시스템의 주 서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/6fc12038-bc12-4fda-bce1-fd215a556ce7)

위 구조에서 알림 서버는 다음 기능을 제공한다.
- 알림 전송 API
- 알림 검증: 이메일 주소, 전화번호 등에 대한 기본적 검증 수행
- DB 또는 캐시 질의: 알림에 포함시킬 데이터를 가져오는 기능
- 알림 전송: 알림 데이터를 메시지 큐에 넣는다. 본 설계안의 경우 하나 이상의 메시지 큐를 사용하므로 알림을 병렬적으로 처리할 수 있다.

이메일 형태의 알림을 보내는데 사용하는 API 예제는 다음과 같다.

`POST https://api.example.com/v1/sms/send`

```json
{
  "to": [
    {
      "user_id": 123456
    }
  ],
  "from": {
    "email": "from_address@example.com"
  },
  "subject": "Hello, World!",
  "content": [
    {
      "type": "text/plain",
      "value": "Hello, World!"
    }
  ]
}
```

캐시는 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시한다.

위 서비스에서 메시지 큐는 다음과 같은 특징이 있다.
- 시스템 컴포넌트 간 의존성을 제거하기 위해 사용
- 다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할 수행
- 위 설계안에선 알림의 종류별로 별도의 메시지 큐를 사용함.
  - 제3자 서비스 가운데 하나에 장애가 발생해도 다른 종류의 알림은 정상 동작
  - (내 생각) retry 로직을 추가할 수 있지 않을까?

## 3단계: 상세 설계
### 안정성
분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 반드시 고려해야 한다.

데이터 손실 방지
- 알림 시스템은 알림 데이터를 DB에 보관하고 재시도 메커니즘을 구현해야 한다.
- 알림 로그를 DB에 유지하는 것이 한 가지 방법이다.

알림 중복 전송 방지
- 같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 불가능하다. → 빈도를 줄이는데 초점을 두자.
- 보내야 할 알림이 도착하면 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 살핀다.
  - 중복된 이벤트라면 버리고, 그렇지 않으면 알림을 발송한다.

### 추가로 필요한 컴포넌트 및 고려사항
알림 템플릿
- 알림 템플릿은 알림 메시지 형식의 유사성을 고려하여 알림 메시지의 모든 부분을 처음부터 다시 만들 필요 없도록 해준다.
- 템플릿은 파라미터나 스타일, 추적 링크를 조정하기만 하면 사전에 지정한 형식에 맞춰 알림을 만들어 내는 틀이다.
- 전송될 알림들의 형식을 일관성 있게 유지할 수 있고, 오류 가능성뿐 아니라 알림 작성에 드는 시간도 줄일 수 있다.

알림 설정
- 사용자가 알림 설정을 상세히 조절할 수 있도록 **알림 설정 테이블**을 이용한다.
- 알림 수단마다 허용 여부를 확인 → 알림을 보내기 전 필터링 필요

||||
|--|--|--|
|user_id|bigint||
|channel|varchar|알림이 전송될 채널. 푸시 알림, 이메일, SMS 등|
|opt_in|boolean|해당 채널로 알림을 받을 것인지의 여부|

전송률 제한
- 한 사용자가 받을 수 있는 알림의 빈도를 제한하여 너무 많은 알림을 보내지 않도록 한다.
- 사용자의 편의성을 고려

재시도 방법
- 제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다.
- 같은 문제가 계속해서 발생하면 개발자에게 alert

큐 모니터링
- 메시지 큐가 중추적인 역할을 하기에, 알림 시스템 모니터링 시 중요한 메트릭은 큐에 쌓인 알림의 개수다.
- 알림의 개수가 너무 크면 작업 서버들이 이벤트를 빠르게 처리하고 있지 못하다는 뜻.

이벤트 추적
- 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다.
- 데이터 분석 서비스는 보통 이벤트 추적 기능도 제공한다.

### 수정된 설계안
![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/10a6e1bb-8102-4842-a918-a40aec78b877)

- 알림 서버에 인증(authentication)과 전송률 제한(rate-limiting) 기능이 추가되었다.
- 전송 실패에 대응하기 위한 재시도 기능이 추가되었다. 전송에 실패한 알림은 다시 큐에 넣고 지정된 횟수만큼 재시도한다.
- 전송 템플릿을 사용하여 알림 생성 과정을 단순화하고 알림 내용의 일관성을 유지한다.
- 모니터링과 추적 시스템을 추가하여 시스템 상태를 확인하고 추후 시스템을 개선하기 쉽도록 하였다.