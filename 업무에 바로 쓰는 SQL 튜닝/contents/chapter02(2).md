# 2-2장. 논리적인 SQL 개념 용어
SQL 문 작성에 필요한 주변 오브젝트와 SQL 문의 상호관계, 연관성과 알고리즘에 관한 논리적 개념 용어를 정리해보자.

## 서브쿼리 위치에 따른 SQL 용어
**서브쿼리(subquery)란 쿼리 안의 보조쿼리를 가리키는 용어이다.** 가장 바깥쪽의 `SELECT` 문인 메인쿼리를 기준으로 내부에 `SELECT` 문을 추가로 작성해서 서브쿼리를 만든다.  
작성하는 위치에 따라 부르는 용어가 다르다.

```sql
SELECT (SELECT ... FROM ...) # SELECT 절: 스칼라 서브쿼리
  FROM (SELECT ... FROM ...) # FROM 절: 인라인 뷰
WHERE 컬럼명 IN (SELECT ... FROM ...) # WHERE 절: 중첩 서브쿼리
```

### 스칼라 서브쿼리
메인쿼리의 `SELECT` 절에 있는 또 다른 `SELECT` 절을 말한다. 메인쿼리의 `SELECT` 절에서는 최종 출력하려는 열들이 나열되므로, 출력 데이터 1건과 스칼라 서브쿼리의 결과 건수가 일치해야 한다. 만약 스칼라 서브쿼리의 결괏값이 2개 이상 나온다면 에러가 발생할 것이다.  
**즉, 스칼라 서브쿼리의 결괏값은 1행 1열의 구조로 출력되어야 한다.**

보통 스칼라 서브쿼리는 출력되는 데이터 건수가 1건이어야 하므로 집계함수(`max`, `min`, `avg`, `sum`, `count` 둥)가 자주 쓰인다.
```sql
SELECT 이름,
       (SELECT COUNT(*)
          FROM 학생 AS 학생2
        WHERE 학생2.이름 = 학생1.이름) 카운트
FROM 학생 AS 학생1;
```

### 인라인 뷰
메인쿼리의 `FROM` 절에 있는 또 다른 `SELECT` 절을 말한다. `FROM` 절 내부에서 일시적으로 뷰를 생성하는 방식이므로 인라인 뷰라 불린다. 인라인 뷰의 결과는 내부적으로 메모리 또는 디스크에 임시 테이블을 생성하여 활용한다.
```sql
SELECT 학생2.학번, 학생2.이름
  FROM (SELECT *
          FROM 학생
        WHERE 성별 = '남') 학생2;
```

### 중첩 서브쿼리
메인쿼리의 `WHERE` 절에 있는 또 다른 `SELECT` 절을 말한다. `WHERE` 절에서 단순한 값을 비교 연산하는 대신, 서브쿼리를 추가하여 비교 연산하기 위해 중첩 서브쿼리를 사용한다.  
`WHERE` 절에서 중첩 서브쿼리와 비교할 때는 보통 비교 연산자를 비롯해 `IN`, `EXISTS`, `NOT IN`, `NOT EXISTS` 문을 많이 사용한다.
```sql
SELECT *
  FROM 학생
WHERE 학번 = (SELECT MAX(학번) FROM 학생)
```

## 메인쿼리와의 관계성에 따른 SQL 용어
서브쿼리와 메인쿼리의 관계성에 따른 SQL 용어를 정리해보자. 서브쿼리는 그 자체가 독립적인 형태로 존재할 수도 있고 메인쿼리와 끈끈한 관계를 유지하며 존재할 수도 있다.

### 비상관 서브쿼리
**비상관 서브쿼리(non correlated subquery)는 메인쿼리와 서브쿼리 간에 관계성이 없음을 의미한다.** 서브쿼리가 독자적으로 실행한 뒤 메인쿼리에게 그 결과를 던져주는 형태인 것이다.

다시 말해, 비상관 서브쿼리에서는 서브쿼리가 먼저 실행된 뒤 그 결과를 메인쿼리가 활용한다. **서브쿼리 실행 → 메인쿼리 실행의 순서로 실행된다.**

```sql
SELECT *
  FROM 학생
WHERE 학번 IN (SELECT 학번
                FROM 학생
              WHERE 성별 = '남')
```
위 예시는 `성별 = '남'` 조건으로 학생 테이블에서 데이터를 가져온 뒤 그 결과를 메인쿼리의 학생 테이블로 전달하여 최종 데이터를 출력한다.  
// DB 버전 및 옵티마이저에 따라 서브쿼리가 제거되고 하나의 메인쿼리로 통합되는 뷰 병합, 즉 SQL 재작성이 작동할 수도 있다.

### 상관 서브쿼리
**상관 서브쿼리(correlated subquery)는 메인쿼리와 서브쿼리 간에 관계성이 있음을 의미한다.** 서브쿼리가 수행되려면 메인쿼리의 값을 받아야 하므로 서브쿼리와 메인쿼리는 서로 끈끈한 관계를 유지한다.  
상관 서브쿼리는 `SELECT` 절에 작성하는 스칼라 서브쿼리와 `WHERE` 절에 작성하는 중첩 서브쿼리일 때 발생한다.

![](https://velog.velcdn.com/images/songs4805/post/5012c5ba-21dc-4df2-b50b-2ca4de641d0c/image.jpg)

메인쿼리에서 `학생.학번` 데이터를 전달받은 뒤 서브쿼리가 수행되고, 그 결과를 다시 메인쿼리로 전달한다.

전체적인 수행순서는 **메인쿼리 실행(학생.학번 데이터 가져오기) → 서브쿼리 실행(지도교수.학번 = 학생.학번) → 다시 메인쿼리 실행한 뒤 결과 출력(`SELECT * FROM 학생~`)** 과 같다.  
// 이때도 역시 뷰 병합이 작동될 수도 있다.

## 반환 결과에 따른 SQL 용어
서브쿼리의 결과 유형은 수치적 기준으로 구분할 수 있다.

### 단일행 서브쿼리
**단일행 서브쿼리는 서브쿼리 결과가 1건의 행으로 반환되는 쿼리이다.** 메인 쿼리 조건절에서는 `=`, `<`, `>` 등의 연산자와 비교한다. 주로 스칼라 서브쿼리와 동일하다고 볼 수 있다.

![](https://velog.velcdn.com/images/songs4805/post/1d5c95c3-7df9-4a70-837c-63a889207234/image.jpeg)

### 다중행 서브쿼리
**다중행 서브쿼리는 서브쿼리 결과가 여러 건의 행으로 반환되는 쿼리이다.** 그에 따라 메인쿼리의 조건절에는 `IN` 구문으로 서브쿼리에서 반환되는 값들을 받는다.

![](https://velog.velcdn.com/images/songs4805/post/49405e35-2349-4888-bef4-c904f8ad6973/image.jpeg)

위 예시는 다중행 서브쿼리에서 전공코드별 학번 최댓값들을 반환된다. 이후 메인쿼리가 수행되고 최종 결과가 출력된다.

### 다중열 서브쿼리
**다중열 서브쿼리에서는 서브쿼리 결과가 여러 개의 열과 행으로 반환된다.** 그에 따라 메인쿼리의 조건절에서는 `IN` 구문과 함께 서브쿼리에서 반환될 열들을 동일하게 나열해 서브쿼리 결과를 받는다.

![](https://velog.velcdn.com/images/songs4805/post/7679c6de-dfab-44e3-a70e-f7d2f392fa65/image.jpeg)

## 조인 연산방식 용어
## 조인 알고리즘 용어