# 3장. API 게이트웨이: 인그레스 트래픽 관리
## API 게이트웨이가 유일한 해결책일까?
|기능|리버스 프록시|로드밸런서|API 게이트웨이|
|--|--|--|--|
|단일 백엔드|*|*|*|
|TLS/SSL|*|*|*|
|다중 백엔드||*|*|
|서비스 발견||*|*|
|API 조합|||*|
|인가|||*|
|재시도 로직|||*|
|호출률 제한|||*|
|로깅과 추적|||*|
|서킷브레이커|||*|

## API 게이트웨이의 정의
API 게이트웨이는 소비자와 백엔드 서비스 사이의 시스템 에지에 위치하는 관리 도구로, 사전에 정의한 여러 API로의 진입점 역할을 수행한다. 소비자란 최종 사용자가 사용하는 애플리케이션 똔느 다른 내부 시스템 또는 서드파티 애플리케이션이나 시스템 등 어떤 것이든 될 수 있다.

- 제어 부분 : 작업자가 게이트웨이를 다루면서 라우트, 정책, 필요한 텔레메트리 등을 정의하는 영역
- 데이터 부분 : 제어 부분에서 발생하는 모든 작업의 명시, 라우팅되는 네트워크 패킷, 정책의 반영, 텔레메트리의 송출 등이 이뤄지는 영역

## API 게이트웨이의 기능
- API는 보통 네트워크 수준에서 소비자로부터의 모든 API 요청을 받아들이는 리버스 프록시로 동작하며 애플리케이션 수준의 여러 백엔드를 호출하고 그 결과를 종합해 적절한 결과를 리턴한다.
- API GW는 사용자 인증, 호출률 제한, 타임아웃/재시도 등 여러 서비스에 공통적으로 필요한 요구사항을 만족시키며 시스템의 관측용이성 구현을 지원하기 위해 메트릭, 로그, 추적 데이터 등을 제공한다.
- 개발자를 위한 API 수명주기의 관리, API 사용에 대한 온보딩 및 관리의 지원, 기업용 거버넌스 지원 등의 추가 기능을 제공하는 API GW도 많다.

## API 게이트웨이의 배포 위치
<img width="1220" height="526" alt="Image" src="https://github.com/user-attachments/assets/3d1c9c6c-0404-4eb8-88ae-392d55943cb5" />

- 스타트업과 소규모 기업의 경우 API 게이트웨이를 데이터센터나 클라우드의 에지에 배포하는 경우가 많다.
- 단일 API가 전체 백엔드에 대한 진입점 역할을 하며, 이 단일 컴포넌트로 에지의 모든 기능을 제공.

<img width="1187" height="510" alt="Image" src="https://github.com/user-attachments/assets/0cf1b2af-6080-4975-9a16-75081692f9ad" />

- 규모가 큰 조직과 엔터프라이즈의 경우는 보통 API 게이트웨이를 데이터센터 주변의 최초 에지 스택에 포함해 여러 곳에 배포.
- 각 제품, 사업부 또는 조직 부서별로 별개의 게이트웨이를 배포하기도 함.
- 이런 게이트웨이는 구현하는 기능을 분리하고 (거버넌스 요구사항에 따라) 지리적인 위치나 인프라스트럭처의 수용량에 따라 다른 기능을 제공하기도 함.

## API 게이트웨이와 다른 에지 기술의 통합
<img width="521" height="750" alt="Image" src="https://github.com/user-attachments/assets/f42529e8-43c5-4a90-8361-11396c38548c" />

API 기반 시스템의 에지에는 보통 많은 컴포넌트가 배포되어 있다. 이 지점이 바로 소비자와 사용자가 백엔드와 처음 교류하는 지점이며, 그래서 여러 가지 공통적인 이슈들을 여기서 처리한다.

- 모던 에지 기술 스택은 API 기반 애플리케이션이 필요로 하는 기본적인 공통 요구사항을 만족시키는 다양한 기능을 제공한다.
- 어떤 에지 스택은 각각의 기능을 별도로 배포하고 운영하는 컴포넌트로 제공하기도 하고, 또 어떤 스택은 기능과 컴포넌트가 결합되어 있기도 하다.

## API 게이트웨이를 사용해야 하는 이유
- 어댑터/퍼사드 패턴을 이용해 프론트엔드와 백엔드 간의 결합도 낮추기
- 백엔드 서비스의 종합 및 해석을 이용해 사용법을 간소화하기
- 위협 탐지와 완화를 통해 API를 남용과 오용으로부터 보호하기
- API의 활용 방식을 이해하기(관측 용이성)
- API 수명주기 관리를 통해 API를 제품으로 관리하기
- 계정 관리, 비용 청구, 결제 등을 통해 API 수익화하기

## 현재의 API 게이트웨이 분류
|사용 사례|전통적 엔터프라이즈 API GW|마이크로서비스 API GW|서비스 메시 GW|
|--|--|--|--|
|주목적|내부 비즈니스 API와 관련 서비스의 노출, 조합, 관리|내부 비즈니스 서비스의 노출, 조합, 관리|메시 내의 내부 서비스 노출|
|발행 기능|API 관리 팀 또는 서비스 팀이 관리용 API를 이용해 게이트웨이를 등록/수정(수준이 높은 조직은 전달 파이프라인을 통해 이 작업을 수행)|서비스 팀이 배포 과정에서 선언적 코드로 게이트웨이를 등록/수정|서비스 팀이 배포 과정에서 선언적 코드로 게이트웨이를 등록/수정|
|모니터링|관리 및 운영 중심. 예를 들면 소비자별 API 호출 수, 에러 보고 등을 수행|개발자 중심. 예를 들면 레이턴시, 트래픽, 에러, 포화도 등을 관측|플랫폼 중심. 예를 들면 활용도, 포화도, 에러 등을 관측|
|이슈의 처리 및 디버깅|L7 에러 처리(eg. 커스텀 에러 페이지). 트러블슈팅의 경우 스테이징 환경에서 게이트웨이/API의 로그를 이용해 이슈를 디버깅한다.|L7 에러 처리(eg. 커스텀 에러페이지, 장애 극복, 페이로드). 이슈의 디버깅은 더 상세한 모니터링의 더 상세한 모니터링의 설정. 트래픽 복사 및 카나리 방식을 이용해 문제를 재현한다.|L7 에러 처리(eg. 커스텀 에러페이지, 페이로드). 트러블 슈팅은 더 상세한 모니터링의 설정 및 트래픽 'tapping'을 활용해 특정 서비스 간 통신을 확인하고 디버깅한다.|
|테스트|QA, 스테이징, 프로덕션 등 여러 환경을 운영한다. 자동화된 통합 테스트 및 API 배포를 수행한다. 호환성과 안정성을 위해 소비자 주도 API 버저닝을 활용한다.|카나리 라우팅 및 다크 론칭을 이용해 동적 테스트를 수행한다. 계약 테스트를 이용해 관리 능력을 업그레이드한다.|카나리 라우팅을 이용해 동적 테스트를 수행한다.|
|로컬 개발 환경||컨테이너나 K8s 같은 오케스트레이션 플랫폼을 이용해 게이트웨이를 로컬 환경에 배포한다.|K8s 같은 오케스트레이션 플랫폼을 이용해 게이트웨이를 로컬 환경에 배포한다.|
|사용자 경험|웹 기반 관리 UI, 개발자 포털, 서비스 카탈로그 등을 지원한다.|IaC 또는 CLI를 활용하며 간단한 개발자 포털과 서비스 카탈로그를 지원한다.|IaC 또는 CLI를 활용하며 제한된 기능의 서비스 카탈로그를 지원한다.|

## API 게이트웨이 배포: 장애에 대한 이해와 관리
- API GW는 보통 배포 방식이나 배포 개수와는 관계없이, 전부는 아니더라도 대부분의 사용자 요청에 있어 중요한 지점에 위치한다.
- 보통 에지에 배포된 GW에 장애가 발생하면 전체 시스템을 사용할 수 없게 된다.
- 업스트림에 배포된 GW에 장애가 발생하면 일부 핵심 서브시스템을 사용할 수 없게 된다.

### API 게이트웨이도 단일 실패 지점이다
- 표준 웹 기반 시스템이라면 보통 DNS가 가장 분명한 단일 실패 지점이다. DNS는 보통 외부 시스템이지만 여기서 장애가 발생하면 탈출구는 없으며 사이트는 사용할 수 없게 될 것이다.
- 전역 및 지역 L4 LoadBalancer이며, 배포 위치와 설정에 따라 방화벽이나 WAF 같은 보안 에지 컴포넌트도 단일 실패 지점이 된다.
- GW의 기능에 더 많이 의존할수록 장애가 발생했을 때의 위험과 영향도는 높아진다.

### 문제의 탐지와 해결
- 모니터링 시스템으로부터 적절한 신호를 수집하고 확인할 수 있도록 하는 것.
- 팀은 내부 및 외부 고객을 위한 SLA의 기반이 되는 SLO를 이용해 소통해야

### 장애와 문제의 해결
- 전담 팀, 긴급 대응 팀, ...
- 장애가 해결되고 나면 비난 없는 건설적인 회고를 진행해 장애와 관련된 모든 것을 문서화해야 함.

### 위험의 완화
- API GW의 고가용성은 보통 여러 인스턴스를 실행하는 것으로 시작한다.
- 온프레미스/코로케이션 환경 - 여러 이중화 하드웨어 장비를 여러 지역에 분산해 운영.
- 클라우드 환경 - API 게이트웨이를 다중 가용성 존/데이터 센터 및 지역에 분산 운영.
- 전역 LB가 API GW 인스턴스 앞에 배포되어 있다면 헬스 체크를 적절히 설정해야 하며 장애 조치 절차도 정기적으로 테스트해야 한다.

LB의 API GW 장애 조치 절차는 서비스의 지속성과 관련된 요구사항을 모두 만족시켜야 함. 보편적인 문제는 아래와 같음
- 백엔드 상태가 올바르게 마이그레이션되지 않아 스티키 세션 장애를 유발하는 사용자 클라이언트 상태 관리 문제
- 클라이언트가 지리적 위치를 고려하지 않는 리다이렉트 문제
- 리더 산출 컴포넌트의 장애로 데드락이 발생해 모든 백엔드에 장애가 발생하는 등 의도하지 않은 연속적 장애

## API 게이트웨이 구현의 보편적인 위험
- API GW 루프백
  - 모든 서비스 간 트래픽이 일단 네트워크를 벗어났다가 다시 게이트웨이로 유입되면 성능, 보안, 비용 문제를 유발할 수 있다.
    - 클라우드 서비스는 egress 및 가용성 존 간의 트래픽에는 비용을 과금하는 경우가 많음.
  - 이 패턴은 서비스의 수가 어느 수준 이상으로 늘어나면 확장성이 뒷받침되지 않아 GW에 과부하가 발생해 병목이 되어 진정한 단일 실패 지점이 되어버린다.
  - 어떤 형태든 내부의 서비스 발견 메커니즘을 사용해 모든 내부 요청이 내부 네트워크에서 이뤄지도록 해야 함. (서비스 메시)
- API GW를 ESB처럼 활용
  - GW와 서비스나 애플리케이션이 강하게 결합되는 결과 → 시스템 안정성 낮아짐.
- 모두가 거북이가 되는 현상
  - 간단한 서비스 업그레이드도 여러 게이트웨이 팀과 조율을 해야 하거나
  - 이해용이성 이슈 발생 등 변화의 비용이 너무 높아지는 문제
  - 모든 네트워크 홉의 비용이 자연스레 높아져 성능에 영향을 미치는 문제