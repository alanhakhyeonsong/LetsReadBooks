# 8장. 다중 칼럼 속성
### 목표: 다중 값 속성 저장
집 전화번호, 회사 전화번호, 팩스 번호, 휴대폰 번호 외에 다른 전화번호가 필요하다면 일일이 컬럼을 추가해야할까?

### 안티패턴: 여러 개의 칼럼 생성
```sql
CREATE TABLE Bugs (
  bug_id SERIAL PRIMARY KEY,
  description VARCHAR(1000),
  tag1 VARCHAR(20),
  tag2 VARCHAR(20),
  tag3 VARCHAR(20)
);

UPDATE Bugs SET tag2 = 'performance' WHERE bug_id = 3456;
```

|bug_id|description|tag1|tag2|tag3|
|--|--|--|--|--|
|1234|저장 시 죽어버림|crash|NULL|NULL|
|3456|성능을 개선해야 함|printing|performance|NULL|
|5678|XML 지원해야 함|NULL|NULL|NULL|

#### 값 검색
- 주어진 태그를 가진 버그를 찾으려면 세 컬럼을 모두 확인해야 한다.
- 태그 대상이 2개라면 두 태그를 모두 가진 버그를 찾아야 할 수도 있다.
  - AND, OR 우선순위를 잘 쳐야 함.
  - 그나마 IN 절을 사용하면 좀 더 간결해질 순 있음.

#### 값 추가와 삭제
- 어느 컬럼이 비어있는지 알 수 없기 때문에 단순히 `UPDATE`를 사용하기도 어렵다.
- `NULLIF()` 함수를 사용하거나, `CASE`문으로 반복되는 문자열을 쿼리에 작성해야 한다.

#### 유일성 보장
다중 컬럼 속성 안티패턴을 사용하는 경우엔 유일성 보장이 어려워진다.

```sql
INSERT INTO Bugs (description, tag1, tag2, tag3)
  VALUES ('printing is slow', 'printing', 'performance', 'performance');
```

#### 값의 수 증가 처리
컬럼 세 개가 모자랄 수도 있다. 추가될 수 있다는 말이다. 이렇게 되면 다음과 같은 이유로 비용이 많이 든다.

- 이미 데이터를 포함하고 있는 DB 테이블 구조를 변경하려면 테이블 전체를 잠금 설정하고 다른 클라이언트의 접근을 차단하는 과정이 필요하다.
- 어떤 DB는 희망하는 구조의 새로운 테이블을 정의해 예전 테이블에서 모든 데이터를 복사한 다음 예전 테이블을 삭제하는 식으로 테이블 변경을 구현한다. 테이블에 많은 데이터가 쌓여 있다면 작업에 많은 시간이 걸린다.
- 다중 컬럼 속성의 집합에 컬럼을 추가한 경우, 모든 애플리케이션에서 이 테이블을 참조하는 모든 SQL 문을 확인해 새로운 컬럼을 지원하도록 수정해야 한다.

### 안티패턴 인식 방법
사용자 인터페이스나 문서에 여러 개의 값을 할당할 수 있지만 최대 개수가 제한되어 있는 속성이 기술되어 있다면, 다중 컬럼 속성 안티패턴이 사용되고 있음을 나타내는 것으로 볼 수 있다.

- "태그를 최대 몇 개까지 붙일 수 있도록 지원해야 하지?"
  - 다중 값 속성을 위해 테이블에 얼마나 많은 컬럼을 정의해야 하는지를 결정하려는 것이다.
- "SQL에서 여러 컬럼을 한꺼번에 검색하려면 어떻게 해야 하지?"
  - 주어진 값을 여러 컬럼에 걸쳐 검색해야 한다면, 실제로 하나의 논리적 속성으로 저장되어야 함을 나타낸다.

### 해법: 종속 테이블 생성
가장 좋은 해법은 다중 값 속성을 위한 컬럼을 하나 가지는 종속 테이블을 만드는 것이다. 여러 개의 값을 여러 개의 컬럼 대신 여러 개의 행에 저장하는 것이다. 또한 종속 테이블에 FK를 정의해 해당 값이 `Bugs` 테이블의 부모 행과 연관되도록 한다.

같은 의미를 가지는 각각의 값은 하나의 컬럼에 저장하라.