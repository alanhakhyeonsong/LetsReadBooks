# 5장. 스프링 클라우드 컨피그 서버로 구성 관리
소프트웨어 개발엔 애플리케이션 구성 정보(configuration)와 코드를 분리하는 것이 중요하다. 이 말은 코드에서 하드코딩된 값을 사용하지 않는 것을 의미한다. 이 원칙을 무시하면 구성 정보가 변경될 때마다 애플리케이션을 재컴파일하고 재배포해야 하므로 애플리케이션이 더 복잡해진다.

**애플리케이션 코드에서 구성 정보를 완전히 분리하면 개발자와 운영자가 재컴파일 과정을 거치지 않고 구성 정보를 변경할 수 있다.** 하지만 개발자에겐 애플리케이션과 함께 관리하고 배포해야 할 또 다른 산출물이 생겨 복잡함도 가중된다.

수백 개의 마이크로서비스가 많은 인스턴스를 실행하고 있는 클라우드 기반의 애플리케이션을 처리하고 있다면 프로퍼티 파일을 사용해서 구성 정보를 저장하여 설정하는 방식에는 한계가 있다.

수백 개의 마이크로서비스가 있고 각 마이크로서비스에는 세 가지 환경에 대해 서로 다른 환경 구성이 포함되어 있다 가정해보자. 이 파일을 외부에서 관리하지 않는다면 변경 사항이 있을 때마다 코드 저장소에서 파일을 검색하고, 코드 저장소에서 검색해서 통합 과정을 따라 애플리케이션을 재시작해야 한다. 이런 재앙적인 상황을 피하려면 다음 사항을 고려해야 한다.

- 배포되는 실제 코드와 구성 정보를 완전히 분리한다.
- 여러 환경에서도 절대 변경되지 않는 불변 애플리케이션 이미지를 빌드한다.
- 서버가 시작할 때 마이크로서비스가 읽어 오는 환경 변수 또는 중앙 저장소를 통해 모든 애플리케이션 구성 정보를 주입한다.

## 구성(그리고 복잡성) 관리
클라우드에서 실행하는 마이크로서비스에선 마이크로서비스의 인스턴스가 사람의 개입을 최소화하여 신속하게 시작되어야 하므로 애플리케이션 구성을 관리하는 것은 중요하다. 사람이 서비스를 배포하기 위해 수동으로 구성하거나 건드려야 한다면 애플리케이션에서 구성 불일치나 예기치 않은 장애, 확장 문제 대응을 위한 지연 시간 등이 발생할 수 있다.

- 분리: 서비스의 물리적 배포에서 서비스 구성 정보를 완전히 분리해야 한다. 실제로 애플리케이션 구성 정보는 서비스 인스턴스와 함께 배포되어서는 안 되며, 시작 중인 서비스에 환경 변수로 전달되거나 서비스가 시작될 때 중앙 저장소에서 읽어 들여야 한다.
- 추상화: 서비스 인터페이스 뒷단에 있는 구성 데이터의 접근 방식을 추상화해야 한다. 애플리케이션 구성 데이터를 조회하는 데 서비스 저장소(파일 기반 또는 JDBC 데이터베이스 기반)에서 직접 읽어 오는 코드를 작성하기보다 REST 기반 JSON 서비스를 사용해야 한다.
- 중앙 집중화: 클라우드 기반의 애플리케이션에는 실제로 수백 개의 서비스가 실행 될 수 있어 구성 데이터를 보관하는 데 사용되는 여러 저장소 수를 최소화하는 것이 중요하다. 가능한 적은 수의 저장소로 애플리케이션 구성 정보를 모아야 한다.
- 견고화: 애플리케이션 구성 정보는 배포되는 서비스와 완전히 분리되고 중앙 집중화되므로 사용하고 구현할 솔루션은 가용성이 높고 이중화가 필요하다.

명심해야 할 핵심 사항 중 하나는 **구성 정보를 실제 코드 외부로 분리할 때 외부 의존성이 생겨서 이를 관리하고 버전 제어한다는 것이다.** 애플리케이션 구성을 제대로 관리하지 못하면 탐지하기 어려운 버그와 예기치 않은 장애의 온상이 되기 때문에 애플리케이션 구성 데이터는 추적 가능하고 버전을 제어할 수 있어야 한다고 아무리 강조해도 지나치지 않다.

### 구성 관리 아키텍처
마이크로서비스의 구성 관리는 부트스트래핑 단계에서 일어난다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/e4120eb3-7c6d-4470-b496-4150eeb3f249)

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/dc8b34ab-0790-4733-8d28-90a114987617)

각 단계에 대한 요약은 다음과 같다.

1. 마이크로서비스 인스턴스가 시작되면 서비스 엔드포인트를 호출하여 동작 중인 환경별 구성 정보를 읽어 온다. 구성 관리 서비스에 대한 접속 정보(접속 자격 증명, 서비스 엔드포인트 등)는 마이크로서비스가 시작할 때 전달된다.
2. 실제 구성 정보는 저장소에 보관된다. 구성 저장소 구현체에 따라 구성 데이터를 보관하는 다양한 방법을 선택할 수 있다. 예를 들어 소스 제어되는 파일, 관계형 데이터베이스, 키-값 데이터 저장소 같은 방법이 있다.
3. 애플리케이션 구성 데이터의 실제 관리는 응용 프로그램이 배포되는 방식과는 독립적으로 한다. 구성 관리에 대한 변경 사항은 일반적으로 빌드 및 배포 파이프라인으로 처리되며, 여기에서 수정 사항에 대한 버전 정보는 태그를 달아 여러 환경(개발, 스테이징, 운영 환경 등)에 배포할 수 있다.
4. 관리하는 구성 정보가 변경되면 애플리케이션 구성 데이터를 사용하는 서비스는 변경 사항을 통지받고 애플리케이션 데이터 복제본을 갱신해야 한다.

### 구현 솔루션 선택

|프로젝트 이름|설명|특징|
|--|--|--|
|etcd|Go 언어로 작성된 오픈 소스 프로젝트로 서비스 디스커버리와 키-값 관리에 사용된다. 분산 컴퓨팅 모델을 위해 raft 프로토콜을 사용한다.|매우 빠르며 확장 가능. 분산 가능. 명령줄 기반. 사용 및 설치 용이|
|유레카(Eureka)|넷플릭스가 만들었으며 엄격한 실전 테스트를 거쳤다. 서비스 디스커버리와 키-값 관리에 사용된다.|분산형 키-값 저장소. 유연하지만 구축하는 데 공수 소요. 기본적으로 클라이언트의 동적 갱신 기능 제공.|
|콘술(Consul)|HashCorp가 만들었다. etcd나 유레카와 유사하지만 분산 컴퓨팅 모델에 다른 알고리즘을 사용한다.|빠르다. 직접 DNS와 통합해서 네이티브 서비스 디스커버리 기능을 제공한다. 클라이언트 동적 갱신은 기본 기능에 포함하지 않는다.|
|주키퍼(Zookeeper)|아파치 프로젝트로 분산 잠금 기능을 제공한다. 주로 키-값 데이터를 액세스 하는 구성 관리 솔루션으로 사용된다.|가장 오래되어 실전에서 검증된 솔루션이다. 사용하기 가장 복잡하다. 구성 관리에 사용 가능하지만 이미 아키텍처에서 사용 중일 때만 고려해야 한다.|
|Spring Cloud Configuration Server|오픈 소스 프로젝트로 다양한 백엔드와 함께 전반적인 구성 관리 솔루션을 제공한다.|비분산형 키-값 저장소. 스프링 및 스프링이 아닌 서비스와 긴밀한 통합. 구성 데이터 저장을 위해 공유 파일 시스템, 유레카, 콘술, 깃 등 다양한 백엔드 사용 가능|

여기서 Spring Cloud Config Server를 사용해보자.

- 설치 및 사용이 쉽다.
- 스프링 부트와 밀접하게 통합되어 있다. 몇 가지 간단한 애너테이션을 사용하여 애플리케이션의 모든 구성 데이터를 읽어 올 수 있다.
- 스프링 클라우드 구성 서버는 구성 데이터를 저장하는 많은 백엔드를 지원한다.
- 깃 소스 제어 플랫폼이나 하시코프 볼트와 바로 통합할 수 있다.

