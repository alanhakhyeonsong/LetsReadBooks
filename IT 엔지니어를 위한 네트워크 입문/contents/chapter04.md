# 4장. 스위치: 2계층 장비

네트워크의 가장 핵심적인 장비인 스위치는 2계층 주소인 MAC 주소를 기반으로 동작한다.
![](https://images.velog.io/images/songs4805/post/5616f1eb-56c1-49bc-b74a-dc52f69671df/image.png)

- 스위치는 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 네트워크의 중재자 역할을 한다.
- 아무 설정 없이 네트워크에 연결해도 MAC 주소를 기반으로 패킷을 전달하는 기본 기능을 수행한다.
- 한 대의 장비에서 논리적으로 네트워크를 분리할 수 있는 VLAN 기능을 제공한다.
- 네트워크의 루프를 방지하는 **스패닝 트리 프로토콜(STP)** 과 같은 기능을 기본적으로 가지고 있다.

> 📌 참고: 패킷? 프레임?
> ![](https://images.velog.io/images/songs4805/post/0317751f-adf6-4a50-a92c-2fa6d987f15a/image.png)
>
> 각 계층에서 헤더와 데이터를 합친 부분을 **PDU(Protocol Data Unit)** 라고 부른다.
>
> - 1계층: 비트(Bits)
> - 2계층: 프레임(Frame)
> - 3계층: 패킷(Packet)
> - 4계층: 세그먼트(Segment)
> - 5~7계층: 데이터(Data)

## 1. 스위치 장비 동작

- 스위치는 네트워크에서 경쟁을 없애고 패킷을 동시에 여러 장비가 서로 간섭없이 통신하도록 도와주는 장비이다.
- 여러 단말이 한꺼번에 통신할 수 있어 통신하기 위해 기다리거나 충돌 때문에 대기하는 문제가 해결되고 네트워크 전체의 통신 효율성이 향상된다.
- **누가 어느 위치에 있는지 파악하고 실제 통신이 시작되면 자신이 알고 있는 위치로 패킷을 정확히 전송하는 것이 핵심이다.**
- 스위치는 이를 위해 **MAC 주소 테이블**을 갖고 있다.
- 만약 테이블에 없는 도착지 주소를 가진 패킷이 스위치로 들어오면 스위치는 전체 포트로 패킷을 전송한다.

스위치의 동작 방식은 플러딩, 어드레스 러닝, 포워딩/필터링이 있다.

### 플러딩(Flooding)

스위치를 부팅하면 그 시점에는 네트워크 관련 정보는 아무것도 없다.  
이 시점에서 스위치는 네트워크 통신을 중재하는 자신의 역할을 하지 못하고 허브처럼 동작한다. 허브는 패킷이 들어온 포트를 제외하고 모든 포트로 패킷을 전달한다.

스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식을 **플러딩**이라 한다.

![](https://images.velog.io/images/songs4805/post/01fd54d8-c58f-4f00-9a9e-620b161bd50a/image.png)

이렇게 모든 포트로 패킷을 흘리는 것은 스위치가 LAN에서 동작하므로 자신이 정보를 갖고 있지 않더라도 어딘가에 장비가 있을 수 있다고 가정하고 수행하는 것이다.

![](https://images.velog.io/images/songs4805/post/f581cd7c-8725-4473-922b-a2b21ce9dc5a/image.png)

하지만, 이런 플러딩 동작은 그 횟수가 많아지면 스위치가 제 역할을 못하게 된다. 패킷이 스위치에 들어오면 해당 패킷 정보의 MAC 주소를 보고 이를 학습해 MAC 주소 테이블을 만든 후 이를 통해 패킷을 전송한다.

### 어드레스 러닝(Address Learning)

스위치가 패킷의 도착지 MAC 주소를 확인하여 원하는 포트로 포워딩하는 스위치의 동작을 정상적으로 수행하려면 MAC 주소 테이블을 만들고 유지해야 한다. 이런 테이블을 만들고 유지하는 과정을 **어드레스 러닝**이라 한다.

어드레스 러닝은 패킷의 출발지 MAC 주소 정보를 이용한다. 패킷이 특정 포트에 들어오면 스위치에는 해당 패킷의 출발지 MAC 주소와 포트 번호를 MAC 주소 테이블에 기록한다.  
1번 포트에서 들어온 패킷의 출발지 MAC 주소가 AAAA라면 1번 포트에 AAAA MAC 주소를 가진 장비가 연결되어 있다고 추론할 수 있어 이런 방법으로 주소 정보를 습득한다.

![](https://images.velog.io/images/songs4805/post/11f0a580-c9ff-4a88-b024-b34551415425/image.png)

단, 어드레스 러닝은 **출발지의 MAC 주소 정보를 사용하므로 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없다.** 두 가지 모두 목적지 MAC 주소 필드에서만 사용하기 때문이다.

### 포워딩/필터링(Forwarding/Filtering)

- **포워딩(Forwarding)**: 패킷이 스위치에 들어왔을 때 도착지 MAC 주소를 확인 후 MAC 테이블과 비교해 맞는 정보가 있으면 해당 포트로 패킷을 넘겨주는 것
- **필터링(Filtering)**: 포워딩 도중 다른 포트로는 해당 패킷을 보내지 않는 것

스위치에서는 포워딩과 필터링 작업이 여러 포트에서 동시에 수행될 수 있다. 통신이 다른 포트에 영향을 미치지 않으므로 다른 포트에서 기존 통신작업으로부터 독립적으로 동작할 수 있다.

![](https://images.velog.io/images/songs4805/post/580aa66d-a8f4-49e3-8961-3d2ba315bf1c/image.png)

스위치는 일반적인 유니캐스트에 대해서만 포워딩/필터링 작업을 수행한다.  
BUM 트래픽(브로드캐스트, 언노운 유니캐스트, 멀티캐스트)은 출발지 MAC 주소로 브로드캐스트나 멀티캐스트 모두 출발지가 사용되지 않으므로 이런 트래픽은 전달이나 필터링 작업을 하지 않고 모두 플러딩 한다.

> 📌 참고: LAN에서의 ARP - 스위치 동작
> 이더넷 - TCP/IP 네트워크에선 스위치가 유니캐스트를 플러딩하는 경우는 거의 없다. 패킷을 만들기 전에 통신해야 하는 단말의 MAC 주소를 알아내기 위해 ARP 브로드캐스트가 먼저 수행되어야 하므로 유니캐스트보다 ARP 브로드캐스트가 먼저 네트워크에 전달된다. 이 ARP를 이용한 MAC 주소 습득 과정에서 이미 스위치는 통신하는 출발지와 목적지의 MAC 주소를 습득할 수 있고 유니캐스트 통신이 시작되면 이미 만들어진 MAC 주소 테이블로 패킷을 포워딩, 필터링한다.

## 2. VLAN

### VLAN이란?

**Virtual Local Area Network**: 하나의 물리 스위치에서 여러 개의 네트워크를 사용할 수 있는 가상화 기술

![](https://images.velog.io/images/songs4805/post/e68a3378-8bbc-49e2-96ea-64f71893d09d/image.png)

- VLAN은 물리적 배치와 상관없이 LAN을 논리적으로 분할 및 구성하는 기술이다.
- 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것이므로 유니캐스트, 브로드캐스트도 VLAN 간에 통신할 수 없다.
- 각각의 VLAN 간에 통신을 하기 위해서는 서로 다른 네트워크 간의 통신이므로 3계층 장비가 필요하다.

![](https://images.velog.io/images/songs4805/post/fc87fde1-4dee-4f77-9679-f59598601bfa/image.png)

- VLAN을 사용해 물리적으로 다른 층에 있는 단말을 하나의 VLAN을 사용해 동일한 네트워크로 묶을 수도 있다.
- 같은 층에서 부서별로 네트워크를 분리하거나 일반 PC, IP 전화기, 무선 단말과 같이 서비스나 단말의 성격에 따라 네트워크를 분리할 수 있고 이 경우 3계층 장비를 통해 단말 간 통신을 한다.

![](https://images.velog.io/images/songs4805/post/e6be5687-4040-488f-b47d-c437ddc4f055/image.png)

### 종류와 특징

- 포트 기반  
  → 과거 VLAN 도입 초기 시점에는 스위치가 고가의 장비였기에 하나의 스위치를 분할해 여러 네트워크에서 사용하는게 VLAN을 적용하는 목적이었다. 이처럼 위치를 논리적으로 분할해 사용하는 목적을 가진 VLAN을 포트기반 VLAN이라 한다.

- MAC 주소 기반  
  → 사용자들의 자리 이동이 많아지면서 나온 방식이다. 스위치의 고정 포트에 VLAN을 할당하는 것이 아니라 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN을 할당하는 기술이다. 단말에 따라 VLAN 정보가 바뀔 수 있어 다이나믹 VLAN이라고도 한다.

### VLAN 모드(Trunk/Access) 동작 방식

스위치 포트에 VLAN을 설정하여 네트워크를 분리하면 물리적으로 스위치를 분리할 때보다 효율적으로 장비를 사용할 수 있다.

![](https://images.velog.io/images/songs4805/post/b19c0621-492d-45ab-85c6-665ad258268a/image.png)

여러 개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우에는 각 VLAN 끼리 통신하려면 VLAN 개수만큼 포트를 연결해야 한다. VLAN으로 분할된 스위치는 물리적인 별도의 스위치처럼 취급된다.

![](https://images.velog.io/images/songs4805/post/9d2bcf43-d550-49df-8756-fe023bee3887/image.png)

위 그림같은 상황에선 3개의 포트가 필요하다. VLAN을 더 많이 사용하는 중/대형 네트워크에서 이렇게 VLAN별로 포트를 연결하면 장비 간의 연결만으로도 많은 포트가 낭비된다. 이 문제를 해결하기 위한 것이 VLAN 태그 기능이다.

![](https://images.velog.io/images/songs4805/post/07df6cdf-45d8-4ad4-b97b-6359f2e02c34/image.png)

하나의 포트에 여러 개의 VLAN을 함께 전송할 수 있게 해주는 기능으로 이 포트를 **태그 포트 또는 트렁크 포트**라 한다.

여러 개의 VLAN을 동시에 전송해야 하는 태그 포트는 통신할 때 이더넷 프렝미 중간에 VLAN ID 필드를 끼워 넣어 이 정보를 이용한다. 태그 포트로 패킷을 보낼 때는 VLAN ID를 붙이고 수신 측에서는 이 VLAN ID를 제거하면서 VLAN ID의 VLAN으로 패킷을 보낼 수 있게 된다.

## 3. STP

IT 환경에서는 **SPoF(Single Point of Failure: 단일 장애점)** 로 인한 장애를 피하기 위해 다양한 노력을 한다. SPoF란 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소를 말한다. 네트워크에서도 하나의 장비 고장으로 전체 네트워크가 마비되는 것을 막기 위해 이중화, 다중화된 네트워크를 디자인하고 구성한다.

![](https://images.velog.io/images/songs4805/post/dc2dd26e-4aeb-4122-a4a6-8d7089f9e8b1/image.png)

이런 SPoF를 피하기 위해 스위치 두 대로 네트워크를 디자인하지만, 두 대 이상의 스위치로 디자인하면 패킷이 네트워크를 따라 계속 전송되므로 네트워크를 마비시킬 수 있다. 이런 상황을 **네트워크 루프(Loop)** 라 한다. 이를 예방하려면 별도의 메커니즘이 필요하다.

### 루프란?

루프는 말 그대로 네트워크에 연결된 모양이 고리처럼 되돌아오는 형태로 구성된 상황을 말한다. 이 상황에선 네트워크가 마비되고 통신이 안되는 상황이 발생한다. 발생 원인은 크게 3가지가 있는데, 대부분 브로드캐스트 스톰(Storm)으로 인해 발생한다.

#### 브로드캐스트 스톰(Storm)

네트워크가 루프 구조로 연결된 상태에서 단말에서 브로드캐스트를 발생시키면 스위치는 이 패킷을 패킷이 유입된 포트를 제외한 모든 포트로 플러딩한다. 플러딩된 패킷은 다른 스위치로도 보내지고 이 패킷을 받은 스위치는 패킷이 유입된 포트를 제외한 모든 포트로 다시 플러딩한다. 루프 구조 상태에선 이 패킷이 계속 돌아가는데 이를 브로드캐스트 스톰이라 한다.

3계층 헤더에는 TTL(Time to Live)이라는 패킷 수명을 갖고 있지만, 2계층 헤더에는 이런 라이프타임 메커니즘이 없어 루프가 발생하면 패킷이 죽지 않고 계속 살아남아 패킷 하나가 전체 네트워크 대역폭을 차지할 수 있다.

![](https://images.velog.io/images/songs4805/post/4346c1f3-8e9b-4053-b7bb-b241451be236/image.png)

#### 스위치 MAC 러닝 중복 문제

루프 구조 상태에서는 유니캐스트도 문제를 일으킨다. 같은 패킷이 루프를 돌아 도착지 쪽에서 중복 수신되는 혼란을 일으키기도 하지만 중간에 있는 스위치에서도 MAC 러닝 문제가 발생한다.

스위치는 출발지 MAC 주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷 간이 포트가 달라 MAC 주소를 정상적으로 학습할 수 없다. 스위치 MAC 주소 테이블에서는 하나의 MAC 주소에 대해 하나의 포트만 학습할 수 있으므로 동일한 MAC 주소가 여러 포트에서 학습되면 MAC 테이블이 반복 갱신되어 정상적으로 동작하지 않는데, 이 현상을 MAC Address Flapping이라 한다.

![](https://images.velog.io/images/songs4805/post/eb2799d9-f2b6-4d99-8719-5c7931bb5b57/image.png)

루프 구성 포트 중 하나의 포트만 사용하지 못하도록 셧다운(shutdown)으로 예방할 순 있으나, 수동적인 방법의 한계로 적절히 대응하기 힘들다. 이 때문에 루프를 자동으로 감지해 포트를 차단하고 장애 때문에 우회로가 없을 때 차단된 포트를 스위치 스스로 다시 풀어주는 STP 방식이 개발되었다.

### STP란?

스패닝 트리 프로토콜(Spanning Tree Protocol)은 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘이다.

우선, 전체 스위치가 어떻게 연결되는지 알아야 한다. 이를 알기 위해선 스위치간 정보를 전달하는 방법이 필요한데 이를 위해 스위치는 BPDU(Bridge Protocol Data Unit)라는 프로토콜을 통해 스위치 간 정보를 전달하고 수집된 정보로 전체 네트워크 트리를 만들어 루프 구간을 확인한다.

![](https://images.velog.io/images/songs4805/post/b1ea283f-5960-42fc-a9e9-45833bbd44f7/image.png)
