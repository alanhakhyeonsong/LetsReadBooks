# 11장. 이중화 기술
끊김없는 안정적인 서비스를 제공하기 위해서는 네트워크, 서버, 스토리지와 같은 인프라뿐만 아니라 애플리케이션도 이중화(다중화) 기술을 적용해야 한다.

이중화 기술은 서비스 가용성을 높여주고 가용량을 확장해주기 때문에 안정적인 서비스 제공을 위해 이중화는 필수 요소다.

(이 장의 내용은 백엔드 개발자의 입장에서 알아둘만한 내용들만 요약해보도록 하자.)

## 이중화 기술 개요
### SPoF
> 단일 장애점(Single Point of Failure, SPoF)은 시스템 구성 요소 중 동작하지 않으면 전체 시스템이 중단되는 요소를 말한다. 예를 들어 이더넷 케이블과 전원, 이더넷 허브, 접속 단말들의 NIC 등으로 이루어진 간단한 이더넷 네트워크 시스템에서 네트워크 허브 장치의 전원은 SPoF다. 허브의 전원이 차단됨과 동시에 나머지 모든 요소는 네트워크를 사용할 수 없다. 고가용성을 추구하는 네트워크, 소프트웨어 애플리케이션, 상용 시스템에 단일 장애점이 있는 것은 바람직하지 않다. 단일 고장점 또는 단일 실패점이라고도 한다.

Time-To-Market은 인프라의 민첩성이다. 인프라의 더 본질적인 목표는 더 가용성 높은 서비스에 필요한 인프라를 안정적으로 제공하는 것이다. 따라서 인프라를 설계할 때, 단일 접점의 장애가 전체 서비스에 영향을 미치지 않도록 SPoF를 만들지 않아야 한다.

SPoF는 전체 서비스의 가용성, 연속성, 안정성을 떨어뜨리는 매우 위험한 요소이므로 인프라를 안정적으로 운용하려면 인프라를 설계할 때, **SPoF를 최소화하는 것이 아니라 아예 만들어지지 않도록 설계해야 한다.**

### 이중화의 목적
안정적인 서비스 제공을 위헤 네트워크를 포함한 모든 인프라에서 반드시 갖추어야 할 요소 중 하나는 이중화이다. 인프라를 구성하는 각 요소가 복수 개 이상으로 인프라를 구성해 특정 인프라에 문제가 발생하더라도 이중화된 다른 인프라를 통해 서비스가 지속되도록 해준다.

서비스에 필요한 출발 지점부터 끝 지점까지 속하는 모든 인프라에 이중화 구성을 고려해야 한다. 서비스를 위한 물리적 또는 가상 머신 서버, 서버와 네트워크 장비를 구성해주는 인터페이스, 서버에 연결된 스위치, 다수 서버의 부하 분산을 위한 L4/L7 스위치, 방화벽, 인터넷 게이트웨이, 인터넷 회선 등 인프라의 모든 요소가 이중화 구성이 필요한 항목들이다. 심지어 이 모든 요소가 속한 데이터 센터 자체도 이중화가 필요해 DR 센터나 액티브-액티브 데이터 센터를 구축한다.

이런 이중화 구성은 각 구성 요소가 동시에 운영 중인 상태로 동작할 것인지, 하나의 구성 요소는 운영 상태이고 다른 하나는 대기 상태로 있다가 운영 상태인 인프라에 장애가 발생하면 대기 상태인 인프라가 운영 상태로 전환될 것인지에 따라 액티브-액티브 또는 액티브-스탠바이 형태로 구성한다.

인프라가 이중화되어 있다면 특정 지점에 문제가 발생하더라도 이중화된 인프라를 이용해 서비스 할 수 있다. 특정 인프라 장애 상황에서도 서비스는 가능하므로 서비스의 연속성이 보장되고 이것을 **폴트 톨러런스(Fault Tolerance, FT, 장애 허용, 결함 감내)** 가 보장된다고 말한다.

액티브-스탠바이가 아닌 액티브-액티브로 구성할 땐 이중화된 인프라에서 서비스 요청을 동시 처리할 수 있으므로 **처리 가능한 전체 용량이 증가한다.** 이중화된 인프라는 장비 간 네트워크 연결이나 회선의 대역폭이 증가한다. 다만 이렇게 증가된 인프라 용량을 기준으로 서비스를 수용하면 특정 지점에 장애가 발생했을 때, 인프라 용랴잉 절반으로 떨어지므로 정상적인 서비스가 불가능하다.

**따라서 인프라의 이중화를 구성할 때는 이중화된 인프라 중 일부에서 장애가 발생하더라도 정상적인 서비스에 문제가 없도록 용량을 산정해 설계해야 한다.**

## LACP
1990년대 중반까진 각 벤더별로 장비 간 대역폭을 늘리기 위해 독자적인 방법으로 구현했지만 벤더 독자적인 방법으론 다른 장비끼리 연결할 때 호환성 문제가 발생해 이 부분을 표준화 했다. 이 표준화가 바로 LACP(Link Aggregation Control Protocol)이다.

링크 애그리게이션의 목적은 대역폭 확장을 통한 다음의 두 가지를 제공하는 것이라고 IEEE 802.1AX-2008에 명시되어 있다.
- 링크 사용률 향상
- 향상된 장애 회복

LACP를 사용하면 두 개 이상의 물리 인터페이스로 구성된 논리 인터페이스를 이용해 모든 물리 인터페이스를 액티브 상태로 사용한다. 이것을 통해 스위치와 스위치 또는 스위치와 서버 간 네트워크 대역폭이 물리 인터페이스 수량만큼 확장된다. 또한, 논리 인터페이스를 구성하는 물리 인터페이스 중 일부에서 문제가 발생하더라도 나머지 물리 인터페이스로 서비스를 유지해준다. 액티브-스탠바이가 아니라 액티브-액티브 상태이므로 인터페이스 절체로 인한 지연 없이 서비스를 제공한다.

유의사항은 다음과 같다.
- LACP는 액티브-액티브 구조이므로 LACP로 구성하는 논리 인터페이스의 대역폭을 서비스에 필요한 전체 트래픽 기준으로 서비스 트래픽을 산정하면 안된다.
- LACP를 구성할 때 또 다른 유의사항은 LACP로 구성하는 물리 인터페이스들의 속도가 동일해야 한다는 것이다.

동작 방식은 다음과 같다.
- LACP를 통해 장비 간 논리 인터페이스를 구성하기 위해 LACPDU(LACP Data Unit)이라는 프레임을 사용한다.
- LACP가 연결되려면 LACPDU를 주고받는 장비가 한 장비여야 한다.

모드는 두 가지가 있다.
- 액티브 : LACPDU를 먼저 송신하고 상대방이 LACP로 구성된 경우, LACP를 구성
- 패시브 : LACPDU를 송신하지 않지만 LACPDU를 수신받으면 응답해 LACP를 구성

액티브-액티브, 액티브-패시브 구성은 가능하지만 패시브-패시브 구성은 불가능하다.

## 게이트웨이 이중화
특정 호스트가 동일한 서브넷에 있는 내부 네트워크와 통신할 땐 ARP를 직접 브로드케스트해 출발지와 목적지가 직접 통신한다. 이때 3계층 장비인 라우터의 도움 없이 직접 통신하므로 실무에선 이를 L2 통신이라 한다.  
목적지가 출발지 호스트의 서브넷에 포함되지 않은 외부 네트워크인 경우, 목적지와 통신하기 위해 게이트웨이를 통해야 하는데 이런 통신을 L3 통신이라 한다.  
호스트에 게이트웨이 설정이 되어 있지 않거나 잘못 설정된 경우에는 내부 네트워크 간에만 통신이 되고 외부 네트워크와는 통신이 되지 않는다.

게이트웨이 장비에 장애가 발생하면 어떻게 될까? 장애가 발생한 게이트웨이를 바라보는 하단의 호스트들은 게이트웨이와 통신할 수 없으므로 외부 네트워크와 통신할 수 없게 된다. 3가지 장애 상황은 다음과 같다.

- 게이트웨이 장비 장애
- 게이트웨이와 하단 장비 간 인터페이스 장애
- 게이트웨이와 연결된 하단 장비 장애

게이트웨이 역할을 하는 두 대의 장비가 하나의 IP 주소를 가지면 어떻게 될까? (이때 IP 주소가 게이트웨이이다.) 이런 경우에 사용하는 프로토콜이 FHRP(First Hop Redundancy Protocol)라는 게이트웨이 이중화 프로토콜이다. 게이트웨이 이중화 프로토콜을 사용하면 두 라우터는 실제 IP 외에 추가로 가상 IP 주소와 가상 IP에 대한 MAC 주소를 동일하게 갖는다. 게이트웨이 이중화 프로토콜의 가상 IP는 그룹 내에서 우선순위가 높은 장비가 Active 상태로 유지하고 ARP 요청에 응답한다. 하단 호스트들이 사용할 게이트웨이 IP 주소가 이 가상 IP 주소다.

### FHRP
FHRP는 외부 네트워크와 통신하기 위해 사용되는 게이트웨이 장비를 두 대 이상의 장비로 구성할 수 있는 프로토콜이다. FHRP를 이용해 FHRP 그룹 내의 장비가 동일한 가상 IP를 갖도록 설정하고 FHRP를 설정할 땐 우선순위 값을 이용해 어떤 장비가 가상 IP 주소에 대한 액티브 역할을 할 것인지 결정한다. 이 그룹의 장비는 물리적으로 다른 장비지만 가상 IP와 가상 IP MAC 주소도 동일하다.

### VRRP
게이트웨이 장애 복구를 위한 프로토콜

### 올 액티브 게이트웨이 이중화
- 가상 IP 주소는 이중화된 장비에서 액티브-스탠바이로 동작한다. 이때 게이트웨이 외부로 가기 위한 경로가 스탠바이더라도 액티브 장비를 통해서만 외부로 나갈 수 있다.

### 애니캐스트 게이트웨이
- 애니캐스트 게이트웨이 기술을 적용하면 각 위치에 같은 주소를 가지는 게이트웨이가 여러 개 동작할 수 있다.