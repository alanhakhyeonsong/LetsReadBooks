# 6장. 로드 밸런서/방화벽: 4계층 장비(세션 장비)
## 4계층 장비의 특징
4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작한다.  
기존 네트워크 장비와 다른 점 중 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중요하다. 4계층 이상에서 동작하는 로드 밸런서, 방화벽과 같은 장비를 **세션 장비**라고 한다.

세션 장비는 추가로 고려해야 할 특징 중 최우선적 요소는 다음과 같다.

- 세션 테이블
  - 세션 장비는 세션 테이블 기반으로 운영된다.
  - 세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요하다.
  - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재한다. 이 부분에 대한 고려가 필요하다.
- Symmetric(대칭) 경로 요구
  - Inbound와 Outbound 경로가 일치해야 한다.
- 정보 변경(로드 밸런서의 경우)
  - IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다.

세션 장비의 이런 요소가 서비스에 영향을 미치므로 네트워크 통신 중간 위치에 세션을 기반으로 동작하는 방화벽, NAT, 로드 밸런서와 같은 장비가 있을 경우, 네트워크 인프라뿐만 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비에 대한 고려가 필요하다.

## 로드 밸런서
**서버나 장비의 부하를 분산하기 위해 사용하는 장비를 흔히 로드 밸런서라고 한다.**  
트래픽을 분배해주는 기능 때문인데 4계층 이상에서 동작하면서 IP 주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있다. 가장 많이 쓰이는 분야는 **웹 서버 부하 분산**이다.

사용자 천 명의 요청을 받는 서버보다 사용자 5천 명의 요청을 동시에 처리해주는 서버의 가격은 5배가 아니라 이보다 훨씬 비싸다. 이처럼 하나의 장비를 내부 부품을 이중화 하거나 큰 부품을 사용하는 것은 비용이 기하급수적으로 높아지기 때문에 작은 장비를 여러 대 묶어 사용하는 방법을 선호하는 데 이를 **scale out**이라 한다.

작은 시스템 여러 대를 운영하더라도 사용자는 서버 배치와 상관없이 하나의 서비스로 보여야 한다. **로드 밸런서가 서비스에 사용되는 대표 IP 주소를 서비스 IP로 갖고, 그 밑에 시스템이 늘어나면 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청을 보낸다.** 이런 로드 밸런서는 웹, 애플리케이션뿐만 아니라 FWLB(방화벽 로드 밸런싱), VPNLB(VPN 로드 밸런싱)와 같이 다양한 서비스를 위해 사용될 수 있다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/c1a1eae6-d6e3-450d-b530-0854d91ba330)

로드 밸런서는 동작하는 계층에 따라 보통 L4와 L7로 나뉜다.

### L4 로드 밸런싱
일반적인 로드 밸런서가 동작하는 방식이다. TCP, UDP 정보(특히 포트 넘버)를 기반으로 로드 밸런싱을 수행한다. 최근의 로드 밸런서는 L4, L7의 기능을 모두 지원하기에 L4 로드 밸런싱만 제공하는 전용장비는 찾기 힘들지만, 장비에서 L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우를 L4 로드 밸런싱이라 한다. 
즉, L4만 지원하던 L4, L7를 모두 지원하는 로드밸런서든 4계층에 대한 정보로 분산처리가 가능하면 L4 로드 밸런싱이라 할 수 있다.

### L7 로드 밸런싱
HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행한다. HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있다. 일반적으로 이런 장비를 ADC라고 부르며 **프록시 역할을 수행한다.** Nginx에서 수행하는 리버스 프록시와 유사한 기능을 갖고 있다.

## L4 스위치
- 용어 그대로 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치.
- 내부 동작 방식은 4계층 로드밸런서지만 외형은 스위치처럼 여러 포트를 가지고 있다. 
- 다양한 네트워크 구성이 가능한 스위치형 로드 밸런서가 가장 대중화되어있다. 
- 부하 분산, 성능 최적화, 리다이렉션 기능을 제공한다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/3b704fc7-3e09-421d-a8fc-6a09aeff4428)

L4 스위치가 동작하려면 가상 서버, 가상 IP, 리얼 서버, 리얼 IP를 설정해야 한다.
- 가상 서버(Virtual Server): 사용자가 바라보는 실제 서비스
- 가상 IP(Virtual IP): 사용자가 접근해야 하는 서비스 IP 주소
- 리얼 서버(Real Server): 실제 서비스를 수행하는 서버
- 리얼 IP(Real IP): 실제 서버의 IP

사용자는 L4 스위치의 가상 IP를 목적지로 서비스를 요청하고 L4 스위치가 목적지로 설정된 가상 IP를 리얼 IP로 다시 변경해 보내준다. 이 과정에서 부하를 어떤 방식으로 분산할지 결정할 수 있다.

## ADC
ADC(Application Delivery Controller)는 애플리케이션 계층에서 동작하는 로드 밸런서다. 4계층에서 동작하는 L4 스위치와 달리 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하므로 다양한 부하 분산, 정보 수정, 정보 필터링이 가능하다. ADC는 이런 동작을 **프록시**로 동작한다.

대부분의 ADC는 L4 스위치의 기능을 포함하고 있다. 대부분의 ADC는 4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공하고 페일오버, 리다이렉션 기능도 함께 수행한다. 이 외에도 애플리케이션 프로토콜을 이해하고 최적화하는 다양한 기능을 제공한다. 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변환 등이 가능하고 애플리케이션 프로토콜 최적화 기능도 제공한다.

플러그인 형태로 보안 강화 기능을 추가로 제공해 WAF(Web Application Firewall) 기능이나 HTML, XML 검증과 변환을 수행할 수 있다.

## L4 스위치 vs ADC
![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/8dceb5f8-13f2-4d44-ad80-c24c5d087865)

- L4 스위치는 4계층에서 동작하며 TCP, UDP 정보를 기반으로 부하를 분산한다.
- TCP 계층에서의 최적화, 보안 기능도 함께 제공한다.
- TCP 레벨의 Dos 공격을 방어할 수 있다.
- 서버 부하를 줄이기 위해 TCP 세션 재사용과 같이 보안과 성능을 높여주는 기능도 제공할 수 있다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/1ff311d6-192b-48d9-bd86-8e112c3e58be)

ADC는 반면,
- 애플리케이션 프로토콜을 이해하고 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화를 제공해 L4 스위치보다 더 다양한 기능을 사용할 수 있다.
- 성능 최적화를 위해 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업을 별도로 수행한다.
  - 그 중 하나가 이미지나 정적 콘텐츠 캐싱 기능이다.

웹 서버에는 콘텐츠 압축 기능이 있지만 ADC에서 이 역할을 수행해 웹 서버의 부하를 줄일 수 있다. ADC는 하드웨어 가속이나 소프트웨어 최적화를 통해 이런 부하가 걸리는 작업을 최적화 하는 기능이 있다.

최근, SSL 프로토콜을 사용하는 비중이 늘면서 웹 서버에 SSL 암복호화 부하가 늘고 있다. 개인정보 보호를 위해 개인정보가 전달되는 일부 페이지에서만 SSL을 사용해왔지만 보안 강화를 위해 웹사이트 전체를 SSL로 처리하는 추세다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/6c704eb6-4e31-48e2-b7da-28bd6199a231)

ADC에선 SSL의 엔드 포인트로 동작해 클라이언트에서 ADC까지의 구간을 SSL로 처리해주고 ADC와 웹 서버 사이를 일반 HTTP를 이용해 통신한다. 대부분 이를 위해 웹 서버 여러 대의 SSL 통신을 하나의 ADC에서 수용하기 위해 ADC에 전용 SSL 가속 카드를 내장한다. 이를 SSL Offloading이라 한다.

||스케일 업(Scale-Up)|스케일 아웃(Scale-Out)|
|--|--|--|
|설명|하드웨어 성능 자체를 업그레이드하거나 더 높은 성능의 시스템으로 마이그레이션 하는 방법|여러 대의 서버로 로드를 분산하는 방법. 서비스 자체를 구분해 나누거나 같은 서비스를 분산해 처리하는 방법이 있다.|
|장점|부품을 쉽게 추가할 수 있으면 시스템 설계 변경 없이 서비스 사용량을 쉽게 늘릴 수 있다.(주로 기존 대형 유닉스 시스템에서 사용함)|스케일 업 방식보다 더 적은 비용으로 시스템 확장이 가능하다. 여러 대의 시스템에 로드를 적절히 분산해 하나의 시스템에 장애가 발생하더라도 서비스에 미치는 영향이 없도록 결함허용을 구현할 수 있다.|
|단점|부품 추가가 어렵다(최근 x86). 시스템이 커질수록 비용이 기하급수적으로 증가한다.|스케일 아웃을 위해 별도의 복잡한 아키텍처를 이해하고 운영해야만 할 수 있다. 프로세스나 네트워크 장비가 추가로 필요할 수 있다.|

## 방화벽
네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비를 방화벽이라 한다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/43052e76-4bab-40f5-adb4-6032054bdc2d)

방화벽은 NAT(Network Address Translation) 동작 방식과 유사하게 세션 정보를 장비 내부에 저장한다. 패킷이 외부로 나갈 때 세션 정보를 저장하고 패킷이 들어오거나 나갈 때 저장했던 세션 정보를 먼저 참조해 들어오는 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 가려낸다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/b37b0efc-e5c5-4882-af61-c92f1d4f2f6d)

이 세션 테이블을 이용해 패킷의 인과 관계를 파악할 수 있어 정책을 간단히 유지할 수 있다. 만약 세션 테이블이 없다면 상태정보를 담아두는 공간이 없어 세션의 방향성을 파악하지 못하게 되고, 이에 따라서 많은 정책을 복잡하게 관리해야 한다. 인터넷 같은 불특정 다수와 통신해야 할 때는 정책의 복잡도가 많이 증가하게 된다. 방화벽은 메모리에 남은 이런 상태와 세션정보를 이용해 패킷을 상세히 로깅하고 관찰할 수 있다.