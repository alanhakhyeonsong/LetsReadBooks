# Chapter 9 - 전문 검색 기술 도전
- 역인덱스는 Dictionary라는 부분과 Postings라는 부분으로 구성되어 있다.
- 대규모 데이터를 작게 나누어 검색
  - 컴팩트한 구현, 간단한 구현
  - 직접 구현함으로써 세세한 요구에 대응할 수 있다.

## 검색 시스템의 아키텍처
'전문 검색'이라 해도 해야 할 것은 매우 많다.

1. 크롤링
2. 저장
3. 인덱싱
4. 검색
5. 스코어링
6. 결과 표시

// 이 책이 오래돼서 책의 저자는 오래된 기술들을 나열했는데, Apache Lucene 기반인 Elasticsearch를 생각하면 좋을 것 같다.

### 전문 검색의 종류
- grep 형
  - 검색 대상을 처음부터 전부 읽는다.
  - 즉시성이 좋고, 검색누락이 없으며, 병렬화나 쿼리 확장이 용이하다.
  - 반면 대규모 환경에서 쉽게 만들려고 하면 다소 무리가 따를 듯하다.
- Suffix 형
  - 검색 가능한 형태로 검색 대상 전문을 보유
  - Trie, Suffix Tree, Suffix Array
  - 이론적으로는 가능
  - 정보량이 크고 구현이 어렵다.
- 역인덱스 형
  - term과 문서를 연관짓는다.
  - 밸런스 좋은 아키텍처 → 실제 시스템의 상당수가 역인덱스를 채용
  - 즉시성 측면에서 뛰어나지 않고 검색누락이 생길 수도 있는 결점도 있다.

## 검색엔진의 내부 구조
### 역인덱스의 구조
![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/06dcee12-4083-4461-bb34-f18bd6bf9fb1)

- term과 문서 연관짓기
- term
  - 문서 내의 단어
- 역인덱스 = Dictionary + Postings
  - term을 포함하는 단어를 즉시 발견

### Dictionary 만드는 법
term을 어떻게 선택하느냐라는 문제가 있다. 어떻게 하면 해당 단어를 찾을 수 있을지가 문제다.

- 단어를 term으로 해서 다룬다.
  - 사전 + AC법으로 단어를 분리한다.
    - 사전이 곧 검색 시스템의 단어공간이 된다.
    - 사전에 들어 있는 단어만 검색할 수 있다.
  - 형태소 분석을 수행한다.
    - 문장을 형태소로 나눠 그 품사를 추정한다.
    - 대부분의 경우 내부에 형태소 분석용 사전을 가지고 있다.
    - 형태소 분석기 종류에 따라서는 사전에 없는 단어도 예상할 수 있고 기계학습 등으로 '이 단어는 여기부터 여기까지가 하나의 단어'라고 예측한다.
    - 단어 배열을 고려한다.
    - 단어 배열을 기계학습하는 경우도 있다.
    - 사전을 커스터마이징할 수 있다.
- n-gram을 term으로 다룬다.

![image](https://github.com/alanhakhyeonsong/LetsReadBooks/assets/60968342/b631f39d-0088-42ba-8310-95f39d7c0668)

n-gram은 텍스트를 n자씩 잘라낸 것이다.

n-gram을 Dictionary로서 사용할 경우, 쿼리도 동일한 규칙으로 분할한다. "하테나"로 검색하고자 할 경우, "하테"와 "테나"로 쿼리를 분할한다. 이 두 가지 쿼리로 역인덱스를 조회하면 두 개의 Postings가 얻어진다. 이 양쪽에 포함된 문서번호를 구하는 처리는 교집합을 취한다라고 한다.

n-gram으로는 이따금 잘못된 검색을 수행하는 문제가 있다. 2-gram으로 분할하면 3글자 이상의 경우 검색어를 포함하지 않는 결과를 반환하는 문제도 발생한다. 이를 회피하기 위해 보통은 검색결과가 나온 후에 '필터링'을 수행한다.

- 필터링
  - 검색 결과를 조사해서 확인
  - 대상이 크면 계산량이 많음
    - 대상이 작을수록 좋다.

재현률과 적합률
- 검색의 타당성 평가기준
- 올바른 결과를 반환했는가?
  - 적합률 = 올바른 결과의 수 / 반환한 결과 총수
- 이것저것 망라해서 반환했는가?
  - 재현률 = 올바른 결과의 수 / 적합한 결과 총수

### Postings 작성법
- 출현위치도 저장하는 경우
  - Full Inverted Index
  - 스니핏, 스코어링, 필터링이 용이
- 문서 ID만 저장하는 경우
  - Inverted File Index
  - 크기가 작고 구현이 용이

Postings와 데이터 구조
- 문서 ID 순서
  - 정렬한다 → VB Code
  - 어느 정도의 압축률과 빠른 전개 성능
- 구조: term → 압축된 Postings List
  - key-value 스토어에 적합

### 스코어링
검색결과를 어떤 순서로 표시할 건지는 상당히 중요한 문제다. 이 순위는 해당 검색엔진을 사용자가 사용하고 싶어할지 그렇지 않을지에 직결된다.

- Google의 랭킹 알고리즘은 PageRank다.
- Elasticsearch 내부 랭킹 알고리즘은 TF/IDF를 이용한다.