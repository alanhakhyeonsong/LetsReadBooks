# Chapter 12 - 확장성 확보에 필요한 사고방식
## 확장성에 대한 요구
- 상당수의 서비스가 서버 1대로 동작한다.
  - 2011년 당시 하테나 표준 서버: 4 core CPU, 8GB RAM
    - 피크시 성능은 수천 요청/분
    - 100만 PV/월
  - 고성능 서버: 4 core CPU * 2, 32GB RAM
    - 200만 PV/월
- 하테나에선 수억 PV/월
  - 대규모 서비스는 서버 1대로는 동작할 수 없다.

계층별 확장성
- API 서버
  - 구성이 동일하고 상태를 갖지 않는다. → 용이
- 데이터 소스(DB, 파일 서버 등)
  - read의 분산 → 비교적 용이
    - 메모리를 많이 탑재, 기타
  - write의 분산 → 어렵다.

## 부하 파악
어떻게 확장해갈 것인지를 검토하기 위해선 먼저 서버 부하를 파악할 수 있어야 한다. 각 서버 부하를 파악하기 위해선 서버군을 관리하고 각각의 부하를 적절하게 그래프화하는 것이 중요하다.

- 부하를 볼 때 먼저 Load Average부터 본다.
  - Linux 커널 내에선 프로세스가 다수 동작하고 있다.
  - Load Average : 프로세스가 언제든지 동작할 수 있는 상태이지만, 아직 실제 CPU가 할당되지 않아 대기상태에 있는 프로세스 수의 평균치
  - CPU가 깔끔하게 할당되면 이 값이 0에 가까워진다.
  - CPU 코어 수 이하이면 양호한 편.
- 메모리 사용처에 관해선 사용자 공간이 소비되고 있는 메모리나 공유되고 있는 메모리, 커널이 사용하고 있는 버퍼의 메모리 등이 있다.

### 용도에 맞는 튜닝
- 봇과 사용자를 분리함에 따라 API 서버의 튜닝 정책을 변경해서 그 효율을 중시할지, 응답시간을 중시하는 쪽으로 이끌어갈지, 리소스를 최대한 사용하는 것을 중시하는 쪽으로 운영할지로 운영방향을 나눌 수 있다.

### 서비스 규모와 튜닝
- 부하 파악
  - 서버 관리툴
- 상태 감시
- 부하를 가시화해서 병목이나 이상현상을 파악할 수 있도록 한다.
- OS의 동작원리를 알고 서버 성능을 올바르게 이끌어낸다.