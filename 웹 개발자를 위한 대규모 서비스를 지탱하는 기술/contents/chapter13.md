# Chapter 13 - 다중성 확보, 시스템 안정화
24시간 365일 100% 가동률을 말하지만 실제로 100%를 반드시 달성하긴 어렵다. 가장 중요시하는 것은 SPOF를 제거하는 것이다.
- 99.98% 가동률은 1개월에 10분간 가동에 문제가 있는 정도의 수치를 의미한다.

## 다중성 확보
API 서버에선 확장성을 생각하는 방식과 마찬가지로 여러 대의 서버를 늘어놓는 게 기본이 된다. 중요한 것은 1, 2대 정도 정지하더라도 충분히 처리할 수 있도록 처리능력을 확보해두는 것이다. 특히 수십 대의 서버가 있을 경우 1, 2대가 멈추는 일은 일상다반사다.

서버는 다양한 요인으로 멈추는데, 인위적인 실수거나 서버가 물리적으로 고장 났다거나 메모리에 이상이 생겨 멈춘다거나...

이에 대한 대응으로 로드밸런서로 failover, failback 하여 고장 난 서버를 자동적으로 분리하고, 서버가 복구되면 원상태로 복귀시키는 작업을 수행하고 있다. 로드밸런서는 주기적으로 서버에 대해 헬스체크를 하고 있으며, API 서버나 DB 서버가 살아있는지 여부를 판정하고 있다.

DB 서버같은 경우엔,
- 슬레이브 DB
  - 서버 여러 대를 나열
  - 1, 2대 정지하더라도 충분히 처리할 수 있도록 해둔다.
- 마스터 DB
  - 멀티 마스터
  - 상호간 레플리케이션
  - 전환 타이밍에 따라 sync가 맞지 않을 위험이 남음
    - 이럴 경우 깨끗이 받아들이고 수동으로 복구

## 시스템 안정화와 상반관계
- 안정성 or 자원효율
- 안정성 or 속도
- 한계에 이를 때까지 메모리를 튜닝
  - 메모리 소비가 늘어난다 → 성능 저하 → 장애
- 한계에 이를 때까지 CPU 사용
  - 서버 1대가 다운 → 전체 처리능력 초과 → 장애

## 시스템의 불안정 요인
전형적인 요인만 나열한다면 아래와 같다.

- 애플리케이션/서비스 레벨 → 부하 증가
  - 기능 추가
  - 메모리 누수
  - 지뢰
  - 사용자의 액세스 패턴
  - 데이터량 증가
  - 외부연계 추가
- 하드웨어 → 처리능력 저하
  - 메모리, HDD 장애
  - NIC 장애

## 시스템 안정화 대책
- 적절한 여유 버퍼 유지
  - 메모리량, CPU 부하 → 한계의 7할 운용
- 불안정 요인 제거
  - SQL 부하의 상한선을 미리 정한다.
    - 부하가 높은 SQL을 필요로 하는 경우, 별도 호스트로
  - 메모리 누수를 줄인다.
  - 이상 동작 시 자율 제어
    - 자동 DoS 판정(mod_dosdetector)
    - 자동 재시작(API 서버, 호스트 OS)
    - 자동 쿼리 제거(소요시간이 긴 SQL을 KILL)